<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel - Manage Topics & Content</title>
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(135deg, #f5f7fa, #c3cfe2);
      font-family: 'Roboto', sans-serif;
      padding: 20px 0;
    }
    .container-custom {
      max-width: 1200px;
      background-color: #fff;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      margin: auto;
    }
    h1 {
      text-align: center;
      margin-bottom: 30px;
      color: #343a40;
      font-weight: 600;
    }
    .card-section {
      margin-bottom: 30px;
      border-radius: 15px;
      overflow: hidden;
    }
    .card-section .card-header {
      background-color: #343a40;
      color: #fff;
      font-size: 1.25em;
    }
    .btn-custom {
      width: 100%;
      padding: 12px;
      font-size: 1.1em;
      border-radius: 50px;
      transition: all 0.3s ease;
    }
    .btn-custom:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
    }
    /* Tree List */
    .topic-node {
      border: 1px solid #dee2e6;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 15px;
      background-color: #f8f9fa;
    }
    .topic-node .node-title {
      font-weight: bold;
      color: #495057;
    }
    .topic-node .btn-group-sm > .btn {
      margin-right: 5px;
    }
    .sub-node {
      margin-left: 20px;
      margin-top: 10px;
      border-left: 2px dashed #ccc;
      padding-left: 10px;
    }
    .content-editor {
      min-height: 200px;
      border: 1px solid #ccc;
      padding: 10px;
      overflow-y: auto;
    }
    /* Floating Buttons */
    #floatScrollBtn, #floatOtherBtn {
      position: fixed;
      width: 50px;
      height: 50px;
      background: #4a90e2;
      color: #fff;
      border: none;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      cursor: pointer;
      z-index: 999;
    }
    #floatScrollBtn:hover, #floatOtherBtn:hover {
      opacity: 0.8;
    }
    #floatScrollBtn {
      top: 50%;
      right: 30px;
      transform: translateY(-50%);
    }
    #floatOtherBtn {
      top: 50%;
      right: 90px;
      transform: translateY(-50%);
      background: #dc3545;
    }
    /* Modals */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    .modal-box {
      background: #fff;
      border-radius: 8px;
      padding: 20px;
      max-width: 500px;
      width: 90%;
      text-align: center;
    }
    .modal-box h3 {
      margin-bottom: 20px;
      font-size: 1.1rem;
      color: #333;
    }
    .modal-buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 10px;
    }
    .selected-text-tools {
      border: 1px solid #dee2e6;
      border-radius: 10px;
      padding: 10px;
      margin-top: 10px;
      display: none;
      background-color: #f8f9fa;
    }
    .selected-text-tools .btn {
      margin-right: 5px;
      margin-bottom: 5px;
    }
  </style>
</head>
<body>
  <div class="container-custom">
    <h1><i class="bi bi-journal-text"></i> Admin Panel - Manage Topics & Content</h1>

    <!-- Manage Topics Section -->
    <div class="card card-section">
      <div class="card-header">Manage Topics (exp_topics.json)</div>
      <div class="card-body">
        <div class="mb-3">
          <button class="btn btn-primary btn-custom" onclick="loadExpTopics()">Load exp_topics.json</button>
        </div>

        <div id="topicsTree"></div>

        <hr>

        <!-- Add New Topic/Subtopic Form -->
        <div class="row g-2 align-items-center">
          <div class="col-md-4">
            <input type="text" id="newNodeTitle" class="form-control" placeholder="Title...">
          </div>
          <div class="col-md-4">
            <!-- اختيار إن كان فرع (Branch) أم محتوى (Content) -->
            <select id="newNodeType" class="form-select">
              <option value="branch">Branch</option>
              <option value="content">Content</option>
            </select>
          </div>
          <div class="col-md-4">
            <!-- زر إضافة الموضوع/الفرع/المحتوى -->
            <button class="btn btn-success btn-custom" onclick="addNode()">Add Node</button>
          </div>
        </div>

        <!-- اختيار المكان الذي نضيفه تحته (جذر أم داخل أحدهم) -->
        <div class="row g-2 mt-3 align-items-center">
          <div class="col-md-12">
            <label>Select where to add:</label>
            <select id="parentSelect" class="form-select"></select>
          </div>
        </div>

        <hr>
        <div class="mt-3">
          <button class="btn btn-primary btn-custom" onclick="saveExpTopics()">Save All Changes</button>
        </div>
      </div>
    </div>
    <!-- END Manage Topics Section -->

    <!-- Manage Content Section -->
    <div class="card card-section">
      <div class="card-header">Manage Content (files with dataFile)</div>
      <div class="card-body">
        <!-- Dropdown لاختيار العقد التي تم تعريفها كمحتوى فقط -->
        <div class="mb-3">
          <select id="contentNodesSelect" class="form-select">
            <option value="">-- Select Content Node --</option>
          </select>
        </div>
        <div class="mb-3">
          <button class="btn btn-primary btn-custom" onclick="loadContentFile()">Load Content File</button>
        </div>
        <div id="contentLoadMsg"></div>

        <hr>

        <!-- محرر النصوص -->
        <div class="mb-2">
          <label for="contentEditor" class="form-label">Content Editor</label>
          <div id="contentEditor" class="content-editor" contenteditable="true"></div>
        </div>

        <!-- أدوات النص المحدد -->
        <div id="selectedTextTools" class="selected-text-tools">
          <p><strong>Tools for selected text:</strong></p>
          <button class="btn btn-sm btn-outline-secondary" onclick="copySelectedText()">Copy</button>
          <button class="btn btn-sm btn-outline-secondary" onclick="pasteAtCursor()">Paste</button>
          <button class="btn btn-sm btn-outline-secondary" onclick="selectAllContent()">Select All</button>
          <button class="btn btn-sm btn-outline-secondary" onclick="makeBold()">Bold</button>
          <button class="btn btn-sm btn-outline-secondary" onclick="makeItalic()">Italic</button>
          <button class="btn btn-sm btn-outline-secondary" onclick="addHeading()">Make Heading</button>
          <button class="btn btn-sm btn-outline-secondary" onclick="insertBefore()">Insert Before</button>
          <button class="btn btn-sm btn-outline-secondary" onclick="insertAfter()">Insert After</button>
          <button class="btn btn-sm btn-outline-secondary" onclick="insertInMiddle()">Insert In Middle</button>
          <button class="btn btn-sm btn-outline-secondary" onclick="removeTag()">Remove Tag</button>
          <hr>
          <button class="btn btn-sm btn-outline-secondary" onclick="insertImage()">Insert Image</button>
          <button class="btn btn-sm btn-outline-secondary" onclick="insertVideo()">Insert Video Tag</button>
          <button class="btn btn-sm btn-outline-secondary" onclick="insertIframe()">Insert iFrame</button>
          <button class="btn btn-sm btn-outline-secondary" onclick="insertLink()">Insert Link</button>
          <button class="btn btn-sm btn-outline-secondary" onclick="insertText()">Insert Text</button>
        </div>

        <hr>

        <!-- زر عرض معاينة + حفظ -->
        <div class="row g-2">
          <div class="col-md-6">
            <button class="btn btn-info btn-custom" onclick="previewContent()">Preview</button>
          </div>
          <div class="col-md-6">
            <button class="btn btn-success btn-custom" onclick="saveContentChanges()">Save Content</button>
          </div>
        </div>

        <!-- عرض المعاينة -->
        <div id="previewArea" class="mt-3" style="border:1px solid #ddd; padding:10px; display:none;">
          <h5>Preview:</h5>
          <div id="previewContent"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- الأزرار العائمة -->
  <button id="floatScrollBtn" onclick="toggleScroll()">↓</button>
  <button id="floatOtherBtn" onclick="alert('Floating button clicked!')">?</button>

  <!-- نظام النوافذ المنبثقة (modal) -->
  <div class="modal-overlay" id="alertOverlay">
    <div class="modal-box">
      <h3 id="alertMsg"></h3>
      <div class="modal-buttons">
        <button class="btn btn-primary" id="alertOkBtn">OK</button>
      </div>
    </div>
  </div>
  <div class="modal-overlay" id="confirmOverlay">
    <div class="modal-box">
      <h3 id="confirmMsg"></h3>
      <div class="modal-buttons">
        <button class="btn btn-primary" id="confirmYesBtn">Yes</button>
        <button class="btn btn-danger" id="confirmNoBtn">No</button>
      </div>
    </div>
  </div>
  <div class="modal-overlay" id="promptOverlay">
    <div class="modal-box">
      <h3 id="promptMsg"></h3>
      <input type="text" id="promptInput" class="form-control mb-3">
      <div class="modal-buttons">
        <button class="btn btn-primary" id="promptOkBtn">OK</button>
        <button class="btn btn-secondary" id="promptCancelBtn">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Bootstrap 5 JS Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

  <script>
    /********************************************************************
     *            نظام النوافذ المنبثقة (Alert, Confirm, Prompt)
     ********************************************************************/
    let alertOverlay = document.getElementById('alertOverlay');
    let alertMsg = document.getElementById('alertMsg');
    let alertOkBtn = document.getElementById('alertOkBtn');

    let confirmOverlay = document.getElementById('confirmOverlay');
    let confirmMsg = document.getElementById('confirmMsg');
    let confirmYesBtn = document.getElementById('confirmYesBtn');
    let confirmNoBtn = document.getElementById('confirmNoBtn');

    let promptOverlay = document.getElementById('promptOverlay');
    let promptMsg = document.getElementById('promptMsg');
    let promptInput = document.getElementById('promptInput');
    let promptOkBtn = document.getElementById('promptOkBtn');
    let promptCancelBtn = document.getElementById('promptCancelBtn');

    function customAlert(message) {
      return new Promise(resolve => {
        alertMsg.textContent = message;
        alertOverlay.style.display = 'flex';
        alertOkBtn.onclick = () => {
          alertOverlay.style.display = 'none';
          resolve();
        };
      });
    }
    function customConfirm(message) {
      return new Promise(resolve => {
        confirmMsg.textContent = message;
        confirmOverlay.style.display = 'flex';
        confirmYesBtn.onclick = () => {
          confirmOverlay.style.display = 'none';
          resolve(true);
        };
        confirmNoBtn.onclick = () => {
          confirmOverlay.style.display = 'none';
          resolve(false);
        };
      });
    }
    function customPrompt(message, defVal) {
      return new Promise(resolve => {
        promptMsg.textContent = message;
        promptInput.value = defVal || '';
        promptOverlay.style.display = 'flex';
        promptOkBtn.onclick = () => {
          let val = promptInput.value;
          promptOverlay.style.display = 'none';
          resolve(val);
        };
        promptCancelBtn.onclick = () => {
          promptOverlay.style.display = 'none';
          resolve(null);
        };
      });
    }

    // استبدال دوال alert/confirm/prompt الافتراضية:
    window.alert = async function(msg) { await customAlert(msg); };
    window.confirm = async function(msg) { return customConfirm(msg); };
    window.prompt = async function(msg, defVal) { return customPrompt(msg, defVal); };

    /********************************************************************
     *                 الأزرار العائمة للتمرير
     ********************************************************************/
    let scrollDown = true;
    function toggleScroll(){
      const btn = document.getElementById('floatScrollBtn');
      if(scrollDown){
        window.scrollTo({top: document.body.scrollHeight, behavior: 'smooth'});
        btn.textContent = '↑';
        scrollDown = false;
      } else {
        window.scrollTo({top: 0, behavior: 'smooth'});
        btn.textContent = '↓';
        scrollDown = true;
      }
    }

    /********************************************************************
     *                 إدارة exp_topics.json
     ********************************************************************/
    let expTopics = null;   // يتم تخزين كائن الـ JSON هنا
    let topicsSha = null;   // الـ SHA الخاص بالملف على GitHub
    let currentParentPath = null; // لمعرفة أين نضيف العنصر

    // جلب الملف
    async function loadExpTopics(){
      try {
        const res = await fetch('/api/get-exp-topics');
        const data = await res.json();
        if(!data.success) {
          alert("Failed to load exp_topics.json: " + (data.error || ''));
          return;
        }
        expTopics = data.content;
        topicsSha = data.sha;
        renderTopicsTree();
        fillParentSelect();
      } catch(e){
        console.error(e);
        alert("Error loading exp_topics.json");
      }
    }

    // حفظ الملف
    async function saveExpTopics(){
      if(!expTopics){
        alert("No data loaded yet.");
        return;
      }
      let confirmSave = await confirm("Are you sure you want to save changes to exp_topics.json?");
      if(!confirmSave) return;
      try {
        let body = {
          content: expTopics,
          sha: topicsSha
        };
        const res = await fetch('/api/save-exp-topics', {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify(body)
        });
        const j = await res.json();
        if(j.success){
          alert("Saved successfully!");
        } else {
          alert("Save failed: " + (j.error || ''));
        }
      } catch(e){
        console.error(e);
        alert("Error saving topics.");
      }
    }

    // دالة إعادة عرض شجرة المواضيع
    function renderTopicsTree(){
      const treeContainer = document.getElementById('topicsTree');
      treeContainer.innerHTML = '';
      if(!expTopics || !expTopics.topics) return;

      expTopics.topics.forEach((topic, index) => {
        const node = createNodeElement(topic, ['topics', index], 0);
        treeContainer.appendChild(node);
      });
    }

    // عنصر واحد (قد يكون رئيسي أو فرعي...) - عامل تكرار Recursion
    function createNodeElement(nodeObj, path, level){
      let div = document.createElement('div');
      div.className = "topic-node";
      let label = document.createElement('div');
      label.className = "node-title mb-2";

      let nodeTitle = nodeObj.title || "Untitled";
      label.textContent = nodeTitle;

      // أزرار التحكم
      let btnGroup = document.createElement('div');
      btnGroup.className = "btn-group-sm";
      
      // زر تحريك للأعلى
      let upBtn = document.createElement('button');
      upBtn.className = "btn btn-secondary";
      upBtn.textContent = "▲";
      upBtn.onclick = () => moveNodeUp(path);
      btnGroup.appendChild(upBtn);

      // زر تحريك للأسفل
      let downBtn = document.createElement('button');
      downBtn.className = "btn btn-secondary";
      downBtn.textContent = "▼";
      downBtn.onclick = () => moveNodeDown(path);
      btnGroup.appendChild(downBtn);

      // زر تحرير
      let editBtn = document.createElement('button');
      editBtn.className = "btn btn-warning";
      editBtn.textContent = "Edit";
      editBtn.onclick = () => editNodeTitle(path);
      btnGroup.appendChild(editBtn);

      // زر حذف
      let delBtn = document.createElement('button');
      delBtn.className = "btn btn-danger";
      delBtn.textContent = "Delete";
      delBtn.onclick = () => deleteNode(path);
      btnGroup.appendChild(delBtn);

      label.appendChild(btnGroup);
      div.appendChild(label);

      // لو فيه subtopics
      if(nodeObj.subtopics && Array.isArray(nodeObj.subtopics)){
        nodeObj.subtopics.forEach((subtopic, i) => {
          let subDiv = document.createElement('div');
          subDiv.className = "sub-node";
          let subpath = [...path, 'subtopics', i];
          let element = createNodeElement(subtopic, subpath, level+1);
          subDiv.appendChild(element);
          div.appendChild(subDiv);
        });
      }

      return div;
    }

    // تحريك للأعلى
    function moveNodeUp(path){
      // path مثال: ['topics', 0, 'subtopics', 2]
      // نسير حتى نجد المصفوفة الأب
      let { parentArray, indexInArray } = getParentArrayAndIndex(path);
      if(indexInArray > 0){
        let temp = parentArray[indexInArray];
        parentArray[indexInArray] = parentArray[indexInArray - 1];
        parentArray[indexInArray - 1] = temp;
        renderTopicsTree();
        fillParentSelect();
      }
    }
    // تحريك للأسفل
    function moveNodeDown(path){
      let { parentArray, indexInArray } = getParentArrayAndIndex(path);
      if(indexInArray < parentArray.length - 1){
        let temp = parentArray[indexInArray];
        parentArray[indexInArray] = parentArray[indexInArray + 1];
        parentArray[indexInArray + 1] = temp;
        renderTopicsTree();
        fillParentSelect();
      }
    }

    // تعديل الاسم
    async function editNodeTitle(path){
      let { parentArray, indexInArray } = getParentArrayAndIndex(path);
      let node = parentArray[indexInArray];
      let newTitle = await prompt("Enter new title:", node.title || '');
      if(newTitle !== null){
        node.title = newTitle.trim();
        renderTopicsTree();
        fillParentSelect();
      }
    }

    // حذف العقدة
    async function deleteNode(path){
      let { parentArray, indexInArray } = getParentArrayAndIndex(path);
      let node = parentArray[indexInArray];

      // إن كان node يحوي dataFile فسيتم الحذف أيضًا من GitHub
      if(node.dataFile){
        let confirmDel = await confirm("This is a content node. Deleting will also remove its file from GitHub. Proceed?");
        if(!confirmDel) return;
        // استدعاء API لحذف الملف
        await fetch(`/api/delete-file?filePath=${encodeURIComponent(node.dataFile)}`, {
          method: 'DELETE'
        }).then(r => r.json()).then(resp => {
          if(!resp.success){
            console.warn("Could not delete file from GitHub:", resp.error);
          }
        }).catch(err => console.error(err));
      } else {
        let confirmDel = await confirm("Delete this branch (and all sub-branches)?");
        if(!confirmDel) return;
        // إذا كان يحوي تفرعات فرعية فيها dataFile، يجب حذفها أيضًا...
        // يمكن عمل دالة مساعدة لحذف أية dataFile في التفرعات
        await deleteNestedDataFiles(node);
      }

      parentArray.splice(indexInArray, 1);
      renderTopicsTree();
      fillParentSelect();
    }

    async function deleteNestedDataFiles(node){
      if(!node) return;
      if(node.subtopics && Array.isArray(node.subtopics)){
        for(let st of node.subtopics){
          if(st.dataFile){
            // حذف الملف
            await fetch(`/api/delete-file?filePath=${encodeURIComponent(st.dataFile)}`, { method: 'DELETE' })
              .then(r=>r.json()).then(resp=>{
                if(!resp.success){
                  console.warn("Could not delete file from GitHub (nested):", resp.error);
                }
              }).catch(err=>console.error(err));
          }
          if(st.subtopics){
            await deleteNestedDataFiles(st);
          }
        }
      }
    }

    // دالة للحصول على المصفوفة الأب والمؤشر
    function getParentArrayAndIndex(path){
      // path مثل: ['topics', 0, 'subtopics', 2]
      // نسير في expTopics حتى نصل إلى آخر مستوى قبل العنصر المنشود
      let parentArray = expTopics;
      for(let i = 0; i < path.length - 1; i++){
        parentArray = parentArray[path[i]];
      }
      let indexInArray = path[path.length - 1];
      return { parentArray, indexInArray };
    }

    // إضافة عقدة جديدة
    async function addNode(){
      if(!expTopics) {
        alert("Load exp_topics.json first!");
        return;
      }
      let nodeTitle = document.getElementById('newNodeTitle').value.trim();
      if(!nodeTitle){
        alert("Please enter a title.");
        return;
      }
      let nodeType = document.getElementById('newNodeType').value; // branch or content
      let parentVal = document.getElementById('parentSelect').value; 
      // قد يكون 'root' أو سلسلة path
      let newObj = { title: nodeTitle };

      if(nodeType === "branch"){
        // فرع: نضيف مصفوفة فرعية فارغة
        newObj.subtopics = [];
      } else {
        // محتوى: ننشئ ملفًا له على GitHub (مثال: nodeTitle + random .json)
        // استدعاء API لإنشاء ملف فارغ ونعيد اسمه
        let fileName = generateFileName(nodeTitle);
        let createReq = await fetch('/api/add-file', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ fileName })
        });
        let createRes = await createReq.json();
        if(createRes.success){
          newObj.dataFile = fileName;
        } else {
          alert("Could not create file for content. " + (createRes.error||''));
          return;
        }
      }

      if(parentVal === 'root'){
        expTopics.topics.push(newObj);
      } else {
        let { parentArray, indexInArray } = getParentArrayAndIndex(JSON.parse(parentVal));
        let parentNode = parentArray[indexInArray];
        if(!parentNode.subtopics) parentNode.subtopics = [];
        parentNode.subtopics.push(newObj);
      }

      document.getElementById('newNodeTitle').value = '';
      document.getElementById('newNodeType').value = 'branch';
      renderTopicsTree();
      fillParentSelect();
    }

    // توليد اسم للملف
    function generateFileName(title){
      let sanitized = title.replace(/\s+/g, '_').replace(/[^\w_\-]/g, '');
      let randomPart = Math.floor(Math.random()*100000);
      return `${sanitized}_${randomPart}.json`;
    }

    // تعبئة القائمة المنسدلة لاختيار الأب
    function fillParentSelect(){
      let sel = document.getElementById('parentSelect');
      sel.innerHTML = '';
      let optRoot = document.createElement('option');
      optRoot.value = 'root';
      optRoot.textContent = 'Root';
      sel.appendChild(optRoot);

      // نجمع كل المسارات
      if(!expTopics || !expTopics.topics) return;
      expTopics.topics.forEach((topic, i) => {
        addNodePathOption(sel, topic, ['topics', i], '');
      });
    }
    function addNodePathOption(sel, node, path, prefix){
      let opt = document.createElement('option');
      opt.value = JSON.stringify(path);
      opt.textContent = prefix + node.title;
      sel.appendChild(opt);

      if(node.subtopics && Array.isArray(node.subtopics)){
        node.subtopics.forEach((sub, i) => {
          let newPath = [...path, 'subtopics', i];
          addNodePathOption(sel, sub, newPath, prefix + node.title + " > ");
        });
      }
    }

    /********************************************************************
     *                 إدارة المحتوى (files with dataFile)
     ********************************************************************/
    let currentContentFile = null;
    let currentContentSha = null;
    let originalContentHtml = ''; // للاحتفاظ بالمحتوى الأصلي عند التحميل

    // تعبئة القائمة المحتوية على جميع العقد التي لها dataFile
    // ملاحظة: يمكن استدعاء هذه الدالة بعد أن يتم تحميل expTopics بنجاح
    async function loadContentFileList(){
      let sel = document.getElementById('contentNodesSelect');
      sel.innerHTML = '<option value="">-- Select Content Node --</option>';
      if(!expTopics || !expTopics.topics) return;
      let allContentNodes = getAllContentNodes(expTopics.topics);
      allContentNodes.forEach(node => {
        let opt = document.createElement('option');
        opt.value = node.dataFile;
        opt.textContent = getNodeFullPath(node); // مسار كامل مثلاً "Microbiology > Virology > Herpesviruses"
        sel.appendChild(opt);
      });
    }
    function getAllContentNodes(nodes){
      let result = [];
      nodes.forEach(n => {
        if(n.dataFile){
          result.push(n);
        }
        if(n.subtopics && Array.isArray(n.subtopics)){
          result = result.concat(getAllContentNodes(n.subtopics));
        }
      });
      return result;
    }
    function getNodeFullPath(node){
      // أو يمكن ببساطة عرض node.title
      return node.title || "Untitled";
    }

    // استدعاءها بعد تحميل exp_topics
    // ولكن سنستدعيها مع الضغط على زر Manage Content -> مثلاً عند الضغط loadExpTopics()
    // يمكن دمجها في النهاية داخل loadExpTopics() بعد نجاح التحميل
    async function loadContentFile(){
      let sel = document.getElementById('contentNodesSelect');
      if(!sel.value){
        alert("Please select a content node.");
        return;
      }
      currentContentFile = sel.value;
      try {
        let r = await fetch(`/api/get-content-file?filePath=${encodeURIComponent(currentContentFile)}`);
        let j = await r.json();
        if(!j.success){
          alert("Failed to load content: " + (j.error || ''));
          return;
        }
        currentContentSha = j.sha;
        let contentObj = j.content; // يفترض أن يكون كائن بالشكل { title: "...", content: "<div>...</div>" }
        if(!contentObj.content) contentObj.content = "";
        originalContentHtml = contentObj.content;
        // تعبئة المحرر
        document.getElementById('contentEditor').innerHTML = contentObj.content;
        document.getElementById('contentLoadMsg').innerHTML = `<div class="alert alert-success">Content loaded successfully!</div>`;
      } catch(e){
        console.error(e);
        alert("Error loading content file");
      }
    }

    async function saveContentChanges(){
      if(!currentContentFile){
        alert("No content file selected.");
        return;
      }
      let confirmSave = await confirm("Are you sure you want to save current content?");
      if(!confirmSave) return;
      let contentEditor = document.getElementById('contentEditor');
      let updatedHtml = contentEditor.innerHTML;
      let payload = {
        filePath: currentContentFile,
        sha: currentContentSha,
        newContent: updatedHtml
      };
      try {
        let r = await fetch('/api/save-content-file', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        let j = await r.json();
        if(j.success){
          alert("Content saved!");
          // تحديث originalContentHtml
          originalContentHtml = updatedHtml;
          currentContentSha = j.newSha; // إن عاد بالـSha الجديد
        } else {
          alert("Save failed: " + (j.error || ''));
        }
      } catch(e){
        console.error(e);
        alert("Error saving content file.");
      }
    }

    /********************************************************************
     *          أدوات التحديد في المحرر (نسخ، لصق، تنسيق...)
     ********************************************************************/
    let selectedRange = null;
    document.getElementById('contentEditor').addEventListener('mouseup', () => {
      // عندما يفلت الفأرة نحصل على التحديد
      let sel = window.getSelection();
      if(sel.rangeCount > 0){
        selectedRange = sel.getRangeAt(0);
        let txt = sel.toString();
        let tools = document.getElementById('selectedTextTools');
        if(txt.length > 0){
          tools.style.display = 'block';
        } else {
          tools.style.display = 'none';
        }
      }
    });

    function copySelectedText(){
      if(!selectedRange) return;
      let selText = selectedRange.toString();
      navigator.clipboard.writeText(selText);
    }
    function pasteAtCursor(){
      navigator.clipboard.readText().then(clipText => {
        if(selectedRange){
          selectedRange.deleteContents();
          let node = document.createTextNode(clipText);
          selectedRange.insertNode(node);
        }
      });
    }
    function selectAllContent(){
      let editor = document.getElementById('contentEditor');
      let range = document.createRange();
      range.selectNodeContents(editor);
      let sel = window.getSelection();
      sel.removeAllRanges();
      sel.addRange(range);
    }
    function makeBold(){
      document.execCommand('bold', false);
    }
    function makeItalic(){
      document.execCommand('italic', false);
    }
    function addHeading(){
      document.execCommand('formatBlock', false, 'h3');
    }
    function insertBefore(){
      if(!selectedRange) return;
      customPrompt("Enter HTML to insert before:", "").then(val => {
        if(val){
          let div = document.createElement('div');
          div.innerHTML = val;
          selectedRange.insertNode(div);
        }
      });
    }
    function insertAfter(){
      if(!selectedRange) return;
      customPrompt("Enter HTML to insert after:", "").then(val => {
        if(val){
          // نضع العقدة بعد العنصر المحدد
          selectedRange.collapse(false);
          let div = document.createElement('div');
          div.innerHTML = val;
          selectedRange.insertNode(div);
        }
      });
    }
    function insertInMiddle(){
      if(!selectedRange) return;
      customPrompt("Enter HTML to insert in middle:", "").then(val => {
        if(val){
          // أدخل النص في منتصف التحديد
          let selText = selectedRange.toString();
          let half = Math.floor(selText.length / 2);
          let firstPart = selText.slice(0, half);
          let secondPart = selText.slice(half);

          selectedRange.deleteContents();
          let frag = document.createDocumentFragment();
          frag.appendChild(document.createTextNode(firstPart));
          let div = document.createElement('span');
          div.innerHTML = val;
          frag.appendChild(div);
          frag.appendChild(document.createTextNode(secondPart));
          selectedRange.insertNode(frag);
        }
      });
    }
    function removeTag(){
      document.execCommand('removeFormat', false);
    }
    function insertImage(){
      customPrompt("Enter Image URL (or upload logic can be handled here):", "").then(val => {
        if(val){
          let img = `<img src="${val}" style="max-width:100%; height:auto;">`;
          document.execCommand('insertHTML', false, img);
        }
      });
    }
    function insertVideo(){
      customPrompt("Enter video URL:", "").then(val => {
        if(val){
          let vid = `<video src="${val}" controls></video>`;
          document.execCommand('insertHTML', false, vid);
        }
      });
    }
    function insertIframe(){
      customPrompt("Enter iFrame embed URL:", "").then(val => {
        if(val){
          let iframe = `<iframe src="${val}" style="width:560px; height:315px;"></iframe>`;
          document.execCommand('insertHTML', false, iframe);
        }
      });
    }
    function insertLink(){
      customPrompt("Enter URL:", "").then(url => {
        if(url){
          let selText = selectedRange ? selectedRange.toString() : url;
          let linkHtml = `<a href="${url}" target="_blank">${selText}</a>`;
          document.execCommand('insertHTML', false, linkHtml);
        }
      });
    }
    function insertText(){
      customPrompt("Enter text to insert:", "").then(txt => {
        if(txt){
          document.execCommand('insertText', false, txt);
        }
      });
    }

    function previewContent(){
      let editorHtml = document.getElementById('contentEditor').innerHTML;
      let previewArea = document.getElementById('previewArea');
      let previewContent = document.getElementById('previewContent');
      previewContent.innerHTML = editorHtml;
      previewArea.style.display = 'block';
    }

    // بعد الانتهاء من تحميل expTopics بنجاح، نقوم بتعبئة قائمة المحتوى:
    // يمكن استدعاؤه في نهاية loadExpTopics()
    async function loadExpTopics(){
      try {
        const res = await fetch('/api/get-exp-topics');
        const data = await res.json();
        if(!data.success) {
          alert("Failed to load exp_topics.json: " + (data.error || ''));
          return;
        }
        expTopics = data.content;
        topicsSha = data.sha;
        renderTopicsTree();
        fillParentSelect();
        // تعبئة قائمة المحتوى
        loadContentFileList();
      } catch(e){
        console.error(e);
        alert("Error loading exp_topics.json");
      }
    }
  </script>
</body>
</html>
