<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel - Manage Topics & Content</title>
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@1.10.5/font/bootstrap-icons.css">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
  <!-- مكتبة Marked.js لتحويل Markdown إلى HTML -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <!-- مكتبة Turndown.js لتحويل HTML إلى Markdown عند التحميل -->
  <script src="https://cdn.jsdelivr.net/npm/turndown/dist/turndown.js"></script>
  <style>
    body {
      background: linear-gradient(135deg, #f5f7fa, #c3cfe2);
      font-family: 'Roboto', sans-serif;
      padding: 20px 0;
    }
    .container-custom {
      max-width: 1200px;
      background-color: #fff;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      margin: auto;
    }
    h1 {
      text-align: center;
      margin-bottom: 30px;
      color: #343a40;
      font-weight: 600;
    }
    .card-section {
      margin-bottom: 30px;
      border-radius: 15px;
      overflow: hidden;
    }
    .card-section .card-header {
      background-color: #343a40;
      color: #fff;
      font-size: 1.25em;
    }
    .btn-custom {
      width: 100%;
      padding: 12px;
      font-size: 1.1em;
      border-radius: 50px;
      transition: all 0.3s ease;
    }
    .btn-custom:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
    }
    /* Tree List */
    .topic-node {
      border: 1px solid #dee2e6;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 15px;
      background-color: #f8f9fa;
    }
    .topic-node .node-title {
      font-weight: bold;
      color: #495057;
    }
    .topic-node .btn-group-sm > .btn {
      margin-right: 5px;
    }
    .sub-node {
      margin-left: 20px;
      margin-top: 10px;
      border-left: 2px dashed #ccc;
      padding-left: 10px;
    }
    /* محرر الماركداون + عرض النتيجة */
    #markdown-input {
      border-radius: 15px;
      overflow: auto;
      resize: none;
      height: 300px;
      width: 100%;
      cursor: grab;
    }
    #markdown-input:active {
      cursor: grabbing;
    }
    #markdown-result {
      margin-top: 20px;
      background-color: #fff;
      padding: 20px;
      border-radius: 15px;
      border: 1px solid #ddd;
      min-height: 200px;
    }
    /* تباعد بين الأزرار العائمة */
    #floatManageTriggersBtn,
    #floatToolsBtn,
    #floatScrollBtn {
      margin-bottom: 15px;
    }
    /* زر تعديل/حذف الأدوات المدخلة */
    #floatManageTriggersBtn {
      position: fixed;
      width: 50px;
      height: 50px;
      background: #0d6efd;
      color: #fff;
      border: none;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      cursor: pointer;
      z-index: 999;
      top: 40%;
      right: 30px;
    }
    #floatManageTriggersBtn:hover {
      opacity: 0.8;
    }
    /* زر الأدوات العائم (للـ triggers وغيرها) */
    #floatToolsBtn {
      position: fixed;
      width: 50px;
      height: 50px;
      background: #dc3545;
      color: #fff;
      border: none;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      cursor: pointer;
      z-index: 999;
      top: 50%;
      right: 30px;
    }
    #floatToolsBtn:hover {
      opacity: 0.8;
    }
    /* زر التمرير */
    #floatScrollBtn {
      position: fixed;
      width: 50px;
      height: 50px;
      background: #4a90e2;
      color: #fff;
      border: none;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      cursor: pointer;
      z-index: 999;
      top: 60%;
      right: 30px;
    }
    #floatScrollBtn:hover {
      opacity: 0.8;
    }

    .modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    .modal-box {
      background: #fff;
      border-radius: 8px;
      padding: 20px;
      max-width: 500px;
      width: 90%;
      text-align: center;
    }
    .modal-box h3 {
      margin-bottom: 20px;
      font-size: 1.1rem;
      color: #333;
    }
    .modal-buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 10px;
    }
    .upload-progress {
      margin-top: 10px;
      display: none;
    }
    .uploaded-images-list {
      margin-top: 10px;
    }
    .uploaded-images-list li {
      margin-bottom: 5px;
    }
    .alert-success {
      margin-top: 10px;
    }
    .selection-guides {
      position: absolute;
      border: 2px dashed red;
      pointer-events: none;
      display: none;
    }
    /* التلوين لأنواع الـ triggers */
    .trigger-link {
      color: blue;
    }
    .trigger-video {
      color: darkgreen;
    }
    .trigger-iframe {
      color: purple;
    }
    .trigger-qids {
      color: orange;
    }
    .trigger-text {
      color: brown;
    }
  </style>
</head>
<body>
  <div class="container-custom">
    <h1><i class="bi bi-journal-text"></i> Admin Panel - Manage Topics & Content</h1>

    <!-- Manage Topics Section -->
    <div class="card card-section">
      <div class="card-header">Manage Topics (exp_topics.json)</div>
      <div class="card-body">
        <div class="mb-3">
          <button class="btn btn-primary btn-custom" onclick="loadExpTopics()">Load exp_topics.json</button>
        </div>

        <div id="topicsTree"></div>

        <hr>

        <!-- Add New Topic/Subtopic Form -->
        <div class="row g-2 align-items-center">
          <div class="col-md-4">
            <input type="text" id="newNodeTitle" class="form-control" placeholder="Title...">
          </div>
          <div class="col-md-4">
            <!-- اختيار إن كان فرع (Branch) أم محتوى (Content) -->
            <select id="newNodeType" class="form-select">
              <option value="branch">Branch</option>
              <option value="content">Content</option>
            </select>
          </div>
          <div class="col-md-4">
            <!-- زر إضافة الموضوع/الفرع/المحتوى -->
            <button class="btn btn-success btn-custom" onclick="addNode()">Add Node</button>
          </div>
        </div>

        <!-- اختيار المكان الذي نضيفه تحته (جذر أم داخل أحدهم) -->
        <div class="row g-2 mt-3 align-items-center">
          <div class="col-md-12">
            <label>Select where to add:</label>
            <select id="parentSelect" class="form-select"></select>
          </div>
        </div>

        <hr>
        <div class="mt-3">
          <button class="btn btn-primary btn-custom" onclick="saveExpTopics()">Save All Changes</button>
        </div>
      </div>
    </div>
    <!-- END Manage Topics Section -->

    <!-- Manage Content Section -->
    <div class="card card-section">
      <div class="card-header">Manage Content (files with dataFile)</div>
      <div class="card-body">
        <!-- Dropdown لاختيار العقد التي تم تعريفها كمحتوى فقط -->
        <div class="mb-3">
          <select id="contentNodesSelect" class="form-select">
            <option value="">-- Select Content Node --</option>
          </select>
        </div>
        <div class="mb-3">
          <button class="btn btn-primary btn-custom" onclick="loadContentFile()">Load Content File</button>
        </div>
        <div id="contentLoadMsg"></div>

        <hr>

        <!-- محرر الماركداون -->
        <label for="markdown-input" class="form-label">Markdown Editor (drag to scroll):</label>
        <textarea class="form-control" id="markdown-input"></textarea>

        <!-- زر واحد لتحويل -->
        <div class="row g-2 mt-2">
          <div class="col-md-12">
            <button class="btn btn-primary w-100 btn-custom" onclick="convertMarkdownWithAlert()">
              <i class="bi bi-arrow-left-right"></i> Convert
            </button>
          </div>
        </div>

        <!-- منطقة عرض النتيجة -->
        <div id="markdown-result" style="direction: ltr; margin-top:20px;"></div>

        <hr>

        <!-- زر حفظ & زر طباعة -->
        <div class="row g-2">
          <div class="col-md-6">
            <button class="btn btn-info btn-custom" onclick="printResult()">Print / PDF</button>
          </div>
          <div class="col-md-6">
            <button class="btn btn-success btn-custom" onclick="saveContentChanges()">Save Content</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- زر عائم لعرض كل الـ Tools & Triggers المدخلة -->
  <button id="floatManageTriggersBtn" onclick="openManageTriggersModal()">⚒</button>
  <!-- زر عائم للأدوات المختلفة (triggers, video, link, question-id ...) -->
  <button id="floatToolsBtn" onclick="handleToolsModalClick()">⚙</button>
  <!-- زر عائم للتمرير -->
  <button id="floatScrollBtn" onclick="toggleScroll()">↓</button>

  <!-- نظام النوافذ المنبثقة (modal) -->
  <div class="modal-overlay" id="alertOverlay">
    <div class="modal-box">
      <h3 id="alertMsg"></h3>
      <div class="modal-buttons">
        <button class="btn btn-primary" id="alertOkBtn">OK</button>
      </div>
    </div>
  </div>
  <div class="modal-overlay" id="confirmOverlay">
    <div class="modal-box">
      <h3 id="confirmMsg"></h3>
      <div class="modal-buttons">
        <button class="btn btn-primary" id="confirmYesBtn">Yes</button>
        <button class="btn btn-danger" id="confirmNoBtn">No</button>
      </div>
    </div>
  </div>
  <div class="modal-overlay" id="promptOverlay">
    <div class="modal-box">
      <h3 id="promptMsg"></h3>
      <input type="text" id="promptInput" class="form-control mb-3">
      <div class="modal-buttons">
        <button class="btn btn-primary" id="promptOkBtn">OK</button>
        <button class="btn btn-secondary" id="promptCancelBtn">Cancel</button>
      </div>
    </div>
  </div>

  <!-- نافذة منبثقة خاصة بـ Tools & Triggers -->
  <div class="modal-overlay" id="toolsOverlay">
    <div class="modal-box" id="toolsModalBox">
      <h3>Tools & Triggers</h3>
      <div class="d-grid gap-2">
        <button class="btn btn-outline-secondary" onclick="openTriggerForm('link')">Add Link</button>
        <button class="btn btn-outline-secondary" onclick="openTriggerForm('video')">Add Video</button>
        <button class="btn btn-outline-secondary" onclick="openTriggerForm('iframe')">Add iFrame</button>
        <button class="btn btn-outline-secondary" onclick="openTriggerForm('qids')">Add Q-ID(s)</button>
        <button class="btn btn-outline-secondary" onclick="openTriggerForm('text')">Add Custom Text/Tag</button>
        <button class="btn btn-outline-secondary" onclick="openImageUploader()">Upload Image(s)</button>
      </div>
      <div class="modal-buttons mt-2">
        <button class="btn btn-secondary" onclick="closeToolsModal()">Close</button>
      </div>
    </div>
  </div>

  <!-- نافذة منبثقة لإدارة الأدوات المدخلة (تعديل/حذف/إعادة ترتيب) -->
  <div class="modal-overlay" id="manageTriggersOverlay">
    <div class="modal-box" id="manageTriggersModalBox">
      <h3>Manage Inserted Triggers</h3>
      <div id="insertedTriggersList" class="mb-3" style="text-align:left; max-height:300px; overflow:auto;"></div>
      <div class="modal-buttons">
        <button class="btn btn-secondary" onclick="closeManageTriggersModal()">Close</button>
      </div>
    </div>
  </div>

  <!-- نافذة منبثقة لخطوات إضافة Trigger محدد -->
  <div class="modal-overlay" id="triggerFormOverlay">
    <div class="modal-box" style="text-align: left;">
      <h3 id="triggerFormTitle">Add Link</h3>
      <div id="triggerFormContent"></div>
      <div class="modal-buttons">
        <button class="btn btn-secondary" onclick="closeTriggerForm()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- نافذة منبثقة لرفع الصور -->
  <div class="modal-overlay" id="imageUploadOverlay">
    <div class="modal-box" style="text-align: left;">
      <h3>Upload or Insert Image</h3>
      <div>
        <!-- اختيار صورة من الجهاز -->
        <label class="form-label">Upload from device:</label>
        <input type="file" id="localImageFile" class="form-control" multiple>
        <button class="btn btn-success w-100 mt-2" onclick="uploadLocalImages()">Upload Selected</button>
        <div class="upload-progress" id="uploadProgress">
          <div class="progress mt-2">
            <div class="progress-bar" role="progressbar" style="width: 0%;" id="uploadProgressBar">0%</div>
          </div>
        </div>
        <hr>
        <!-- أو إدخال رابط صورة مباشر -->
        <label class="form-label">Or use image link:</label>
        <input type="text" id="imageLinkInput" class="form-control" placeholder="https://...">
        <button class="btn btn-primary w-100 mt-2" onclick="insertImageLink()">Insert Link</button>
      </div>
      <hr>
      <!-- قائمة الصور المرفوعة مع زر الحذف -->
      <div>
        <h5>Uploaded Images:</h5>
        <ul class="uploaded-images-list" id="uploadedImagesList"></ul>
      </div>
      <div class="modal-buttons">
        <button class="btn btn-secondary" onclick="closeImageUploader()">Close</button>
      </div>
    </div>
  </div>

  <div class="selection-guides" id="selectionBox"></div>

  <!-- Bootstrap 5 JS Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

  <script>
    /****
     *            نظام النوافذ المنبثقة (Alert, Confirm, Prompt)
     ****/
    let alertOverlay = document.getElementById('alertOverlay');
    let alertMsg = document.getElementById('alertMsg');
    let alertOkBtn = document.getElementById('alertOkBtn');

    let confirmOverlay = document.getElementById('confirmOverlay');
    let confirmMsg = document.getElementById('confirmMsg');
    let confirmYesBtn = document.getElementById('confirmYesBtn');
    let confirmNoBtn = document.getElementById('confirmNoBtn');

    let promptOverlay = document.getElementById('promptOverlay');
    let promptMsg = document.getElementById('promptMsg');
    let promptInput = document.getElementById('promptInput');
    let promptOkBtn = document.getElementById('promptOkBtn');
    let promptCancelBtn = document.getElementById('promptCancelBtn');

    function customAlert(message) {
      return new Promise(resolve => {
        alertMsg.textContent = message;
        alertOverlay.style.display = 'flex';
        alertOkBtn.onclick = () => {
          alertOverlay.style.display = 'none';
          resolve();
        };
      });
    }
    function customConfirm(message) {
      return new Promise(resolve => {
        confirmMsg.textContent = message;
        confirmOverlay.style.display = 'flex';
        confirmYesBtn.onclick = () => {
          confirmOverlay.style.display = 'none';
          resolve(true);
        };
        confirmNoBtn.onclick = () => {
          confirmOverlay.style.display = 'none';
          resolve(false);
        };
      });
    }
    function customPrompt(message, defVal) {
      return new Promise(resolve => {
        promptMsg.textContent = message;
        promptInput.value = defVal || '';
        promptOverlay.style.display = 'flex';
        promptOkBtn.onclick = () => {
          let val = promptInput.value;
          promptOverlay.style.display = 'none';
          resolve(val);
        };
        promptCancelBtn.onclick = () => {
          promptOverlay.style.display = 'none';
          resolve(null);
        };
      });
    }

    // استبدال دوال alert/confirm/prompt الافتراضية:
    window.alert = async function(msg) { await customAlert(msg); };
    window.confirm = async function(msg) { return customConfirm(msg); };
    window.prompt = async function(msg, defVal) { return customPrompt(msg, defVal); };

    /****
     *  تفعيل السحب داخل الـ textarea للتمرير
     ****/
    (function enableDragScroll(){
      const mdInput = document.getElementById('markdown-input');
      let isDown = false, startY, scrollTop;
      mdInput.addEventListener('mousedown', e => {
        isDown = true;
        startY = e.pageY - mdInput.offsetTop;
        scrollTop = mdInput.scrollTop;
      });
      mdInput.addEventListener('mouseleave', () => { isDown = false; });
      mdInput.addEventListener('mouseup', () => { isDown = false; });
      mdInput.addEventListener('mousemove', e => {
        if(!isDown) return;
        e.preventDefault();
        const y = e.pageY - mdInput.offsetTop;
        const walk = (y - startY) * 1.5;
        mdInput.scrollTop = scrollTop - walk;
      });
    })();

    let scrollDown = true;
    function toggleScroll(){
      const btn = document.getElementById('floatScrollBtn');
      if(scrollDown){
        window.scrollTo({top: document.body.scrollHeight, behavior: 'smooth'});
        btn.textContent = '↑';
        scrollDown = false;
      } else {
        window.scrollTo({top: 0, behavior: 'smooth'});
        btn.textContent = '↓';
        scrollDown = true;
      }
    }

    /****
     *                 إدارة exp_topics.json
     ****/
    let expTopics = null;   
    let topicsSha = null;   

    async function loadExpTopics(){
      try {
        const res = await fetch('/api/get-exp-topics');
        const data = await res.json();
        if(!data.success) {
          alert("Failed to load exp_topics.json: " + (data.error || ''));
          return;
        }
        expTopics = data.content;
        topicsSha = data.sha;
        renderTopicsTree();
        fillParentSelect();
        loadContentFileList();
        await alert("exp_topics.json Loaded Successfully!");
      } catch(e){
        console.error(e);
        alert("Error loading exp_topics.json");
      }
    }

    async function saveExpTopics(){
      if(!expTopics){
        alert("No data loaded yet.");
        return;
      }
      let confirmSave = await confirm("Are you sure you want to save changes to exp_topics.json?");
      if(!confirmSave) return;
      try {
        let body = {
          content: expTopics,
          sha: topicsSha
        };
        const res = await fetch('/api/save-exp-topics', {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify(body)
        });
        const j = await res.json();
        if(j.success){
          alert("Saved successfully!");
        } else {
          alert("Save failed: " + (j.error || ''));
        }
      } catch(e){
        console.error(e);
        alert("Error saving topics.");
      }
    }

    function renderTopicsTree(){
      const treeContainer = document.getElementById('topicsTree');
      treeContainer.innerHTML = '';
      if(!expTopics || !expTopics.topics) return;

      expTopics.topics.forEach((topic, index) => {
        const node = createNodeElement(topic, ['topics', index], 0);
        treeContainer.appendChild(node);
      });
    }

    function createNodeElement(nodeObj, path, level){
      let div = document.createElement('div');
      div.className = "topic-node";
      let label = document.createElement('div');
      label.className = "node-title mb-2";

      let nodeTitle = nodeObj.title || "Untitled";
      label.textContent = nodeTitle;

      let btnGroup = document.createElement('div');
      btnGroup.className = "btn-group-sm";

      let upBtn = document.createElement('button');
      upBtn.className = "btn btn-secondary";
      upBtn.textContent = "▲";
      upBtn.onclick = () => moveNodeUp(path);
      btnGroup.appendChild(upBtn);

      let downBtn = document.createElement('button');
      downBtn.className = "btn btn-secondary";
      downBtn.textContent = "▼";
      downBtn.onclick = () => moveNodeDown(path);
      btnGroup.appendChild(downBtn);

      let editBtn = document.createElement('button');
      editBtn.className = "btn btn-warning";
      editBtn.textContent = "Edit";
      editBtn.onclick = () => editNodeTitle(path);
      btnGroup.appendChild(editBtn);

      let delBtn = document.createElement('button');
      delBtn.className = "btn btn-danger";
      delBtn.textContent = "Delete";
      delBtn.onclick = () => deleteNode(path);
      btnGroup.appendChild(delBtn);

      label.appendChild(btnGroup);
      div.appendChild(label);

      if(nodeObj.subtopics && Array.isArray(nodeObj.subtopics)){
        nodeObj.subtopics.forEach((subtopic, i) => {
          let subDiv = document.createElement('div');
          subDiv.className = "sub-node";
          let subpath = [...path, 'subtopics', i];
          let element = createNodeElement(subtopic, subpath, level+1);
          subDiv.appendChild(element);
          div.appendChild(subDiv);
        });
      }
      return div;
    }

    function moveNodeUp(path){
      let { parentArray, indexInArray } = getParentArrayAndIndex(path);
      if(indexInArray > 0){
        let temp = parentArray[indexInArray];
        parentArray[indexInArray] = parentArray[indexInArray - 1];
        parentArray[indexInArray - 1] = temp;
        renderTopicsTree();
        fillParentSelect();
        loadContentFileList();
      }
    }
    function moveNodeDown(path){
      let { parentArray, indexInArray } = getParentArrayAndIndex(path);
      if(indexInArray < parentArray.length - 1){
        let temp = parentArray[indexInArray];
        parentArray[indexInArray] = parentArray[indexInArray + 1];
        parentArray[indexInArray + 1] = temp;
        renderTopicsTree();
        fillParentSelect();
        loadContentFileList();
      }
    }
    function getParentArrayAndIndex(path){
      let parentRef = expTopics;
      for(let i = 0; i < path.length - 1; i++){
        parentRef = parentRef[path[i]];
      }
      let indexInArray = path[path.length - 1];
      return { parentArray: parentRef, indexInArray };
    }

    async function editNodeTitle(path){
      let { parentArray, indexInArray } = getParentArrayAndIndex(path);
      let node = parentArray[indexInArray];
      let oldTitle = node.title || '';
      let newTitle = await prompt("Enter new title:", oldTitle);
      if(newTitle !== null){
        newTitle = newTitle.trim();
        if(newTitle === "") return;
        node.title = newTitle;
        if(node.dataFile){
          await renameContentFile(path, node); 
        }
        renderTopicsTree();
        fillParentSelect();
        loadContentFileList();
      }
    }

    function getTitlesChain(path){
      let chain = [];
      function recurse(nodeList, currentPath){
        for(let i=0; i<nodeList.length; i++){
          let nodeObj = nodeList[i];
          let p = [...currentPath, i];
          if(JSON.stringify(p) === JSON.stringify(path)){
            chain.push(nodeObj.title);
            return true;
          }
          if(nodeObj.subtopics && nodeObj.subtopics.length>0){
            let subPath = [...currentPath, i, 'subtopics'];
            if(recurse(nodeObj.subtopics, subPath)) {
              chain.unshift(nodeObj.title);
              return true;
            }
          }
        }
        return false;
      }
      function outer(){
        for(let i=0; i<expTopics.topics.length; i++){
          let nodeObj = expTopics.topics[i];
          if(JSON.stringify(['topics', i]) === JSON.stringify(path)){
            chain.push(nodeObj.title);
            return true;
          }
          if(nodeObj.subtopics && nodeObj.subtopics.length>0){
            let subPath = ['topics', i, 'subtopics'];
            if(recurse(nodeObj.subtopics, subPath)){
              chain.unshift(nodeObj.title);
              return true;
            }
          }
        }
      }
      outer();
      return chain;
    }
    async function renameContentFile(path, node){
      try {
        let oldPath = node.dataFile; 
        let parentPath = path.slice(0, -1);
        let newFileName = "";

        let chainForParent = getTitlesChain(parentPath.slice(0, -1)); 
        let parentChain = chainForParent.map(t => t.replace(/\s+/g, '_').replace(/[^\w_\-]/g, '').toLowerCase()).join('_');
        let childPart = node.title.replace(/\s+/g, '_').replace(/[^\w_\-]/g, '').toLowerCase();
        if(parentChain){
          newFileName = parentChain + "_" + childPart + ".json";
        } else {
          newFileName = childPart + ".json";
        }

        let body = { 
          oldPath, 
          newPath: "exp_data/" + newFileName
        };
        let fullChain = getTitlesChain(path);
        if(fullChain.length > 1){
          let newTitleStr = fullChain.join(" - ");
          body.newTitle = newTitleStr;
        } else {
          body.newTitle = node.title;
        }

        let renameReq = await fetch('/api/rename-file', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        let renameRes = await renameReq.json();
        if(!renameRes.success){
          await alert("Could not rename file: " + (renameRes.error || ''));
          return;
        }
        node.dataFile = newFileName;
      } catch(e){
        console.error(e);
        alert("Error in renameContentFile: " + e.toString());
      }
    }

    async function deleteNode(path){
      let { parentArray, indexInArray } = getParentArrayAndIndex(path);
      let node = parentArray[indexInArray];

      if(node.dataFile){
        let confirmDel = await confirm("This is a content node. Deleting will also remove its file from GitHub. Proceed?");
        if(!confirmDel) return;
        await fetch(`/api/delete-file?filePath=${encodeURIComponent("exp_data/"+node.dataFile)}`, {
          method: 'DELETE'
        }).then(r => r.json()).then(resp => {
          if(!resp.success){
            console.warn("Could not delete file from GitHub:", resp.error);
          }
        }).catch(err => console.error(err));
      } else {
        let confirmDel = await confirm("Delete this branch (and all sub-branches)?");
        if(!confirmDel) return;
        await deleteNestedDataFiles(node);
      }
      parentArray.splice(indexInArray, 1);
      renderTopicsTree();
      fillParentSelect();
      loadContentFileList();
    }

    async function deleteNestedDataFiles(node){
      if(!node) return;
      if(node.subtopics && Array.isArray(node.subtopics)){
        for(let st of node.subtopics){
          if(st.dataFile){
            await fetch(`/api/delete-file?filePath=${encodeURIComponent("exp_data/"+st.dataFile)}`, { method: 'DELETE' })
              .then(r=>r.json()).then(resp=>{
                if(!resp.success){
                  console.warn("Could not delete file from GitHub (nested):", resp.error);
                }
              }).catch(err=>console.error(err));
          }
          if(st.subtopics){
            await deleteNestedDataFiles(st);
          }
        }
      }
    }

    async function addNode(){
      if(!expTopics) {
        alert("Load exp_topics.json first!");
        return;
      }
      let nodeTitle = document.getElementById('newNodeTitle').value.trim();
      if(!nodeTitle){
        alert("Please enter a title.");
        return;
      }
      let nodeType = document.getElementById('newNodeType').value; 
      let parentVal = document.getElementById('parentSelect').value;
      let newObj = { title: nodeTitle };

      if(nodeType === "branch"){
        newObj.subtopics = [];
      } else {
        let fileName = generateFileNameForContent(parentVal, nodeTitle);
        let newJsonTitle = generateTitleFieldForContent(parentVal, nodeTitle);

        let createReq = await fetch('/api/add-file', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ fileName, newJsonTitle })
        });
        let createRes = await createReq.json();
        if(createRes.success){
          newObj.dataFile = fileName; 
        } else {
          alert("Could not create file for content. " + (createRes.error||''));
          return;
        }
      }

      if(parentVal === 'root'){
        expTopics.topics.push(newObj);
      } else {
        let { parentArray, indexInArray } = getParentArrayAndIndex(JSON.parse(parentVal));
        let parentNode = parentArray[indexInArray];
        if(!parentNode.subtopics) parentNode.subtopics = [];
        parentNode.subtopics.push(newObj);
      }

      document.getElementById('newNodeTitle').value = '';
      document.getElementById('newNodeType').value = 'branch';
      renderTopicsTree();
      fillParentSelect();
      loadContentFileList();

      if(nodeType === "content" && newObj.dataFile){
        let sel = document.getElementById('contentNodesSelect');
        sel.value = newObj.dataFile;
        await loadContentFile();
      }
    }

    function generateFileNameForContent(path, newTitle){
      if(path === 'root'){
        let fn = newTitle.replace(/\s+/g, '_').replace(/[^\w_\-]/g, '').toLowerCase();
        return fn + ".json";
      } else {
        let realPath = JSON.parse(path);
        let chainTitles = getTitlesChain(realPath);
        let parentChain = chainTitles.map(t => t.replace(/\s+/g, '_').replace(/[^\w_\-]/g, '').toLowerCase()).join('_');
        let childPart = newTitle.replace(/\s+/g, '_').replace(/[^\w_\-]/g, '').toLowerCase();
        let finalName = "";
        if(parentChain){
          finalName = parentChain + "_" + childPart + ".json";
        } else {
          finalName = childPart + ".json";
        }
        return finalName;
      }
    }
    function generateTitleFieldForContent(path, newTitle){
      if(path === 'root'){
        return newTitle; 
      } else {
        let realPath = JSON.parse(path);
        let chainTitles = getTitlesChain(realPath); 
        if(chainTitles.length > 0){
          return chainTitles.join(" - ") + " - " + newTitle;
        } else {
          return newTitle;
        }
      }
    }
    function fillParentSelect(){
      let sel = document.getElementById('parentSelect');
      sel.innerHTML = '';
      let optRoot = document.createElement('option');
      optRoot.value = 'root';
      optRoot.textContent = 'Root';
      sel.appendChild(optRoot);

      if(!expTopics || !expTopics.topics) return;
      expTopics.topics.forEach((topic, i) => {
        addNodePathOption(sel, topic, JSON.stringify(['topics', i]), '');
      });
    }
    function addNodePathOption(sel, node, path, prefix){
      let opt = document.createElement('option');
      opt.value = path;
      opt.textContent = prefix + node.title;
      sel.appendChild(opt);
      if(node.subtopics && Array.isArray(node.subtopics)){
        node.subtopics.forEach((sub, i) => {
          let newPath = JSON.stringify([...JSON.parse(path), 'subtopics', i]);
          addNodePathOption(sel, sub, newPath, prefix + node.title + " > ");
        });
      }
    }

    /****
     *                 إدارة المحتوى
     ****/
    let currentContentFile = null;
    let currentContentSha = null;
    let originalContentHtml = '';

    function collectContentNodes(nodes, prefix){
      let result = [];
      for(let i=0; i<nodes.length; i++){
        let n = nodes[i];
        let currentPrefix = prefix ? (prefix + " > " + n.title) : n.title;
        if(n.dataFile){
          result.push({
            file: n.dataFile,
            fullPath: currentPrefix
          });
        }
        if(n.subtopics && n.subtopics.length>0){
          result = result.concat(collectContentNodes(n.subtopics, currentPrefix));
        }
      }
      return result;
    }
    function loadContentFileList(){
      let sel = document.getElementById('contentNodesSelect');
      sel.innerHTML = '<option value="">-- Select Content Node --</option>';
      if(!expTopics || !expTopics.topics) return;
      let all = collectContentNodes(expTopics.topics, "");
      all.forEach(obj => {
        let opt = document.createElement('option');
        opt.value = obj.file;
        opt.textContent = obj.fullPath;
        sel.appendChild(opt);
      });
    }

    async function loadContentFile(){
      let sel = document.getElementById('contentNodesSelect');
      if(!sel.value){
        alert("Please select a content node.");
        return;
      }
      currentContentFile = sel.value;
      try {
        let r = await fetch(`/api/get-content-file?filePath=${encodeURIComponent(currentContentFile)}`);
        let j = await r.json();
        if(!j.success){
          alert("Failed to load content: " + (j.error || ''));
          return;
        }
        currentContentSha = j.sha;
        let contentObj = j.content;
        if(!contentObj.content) contentObj.content = "";
        originalContentHtml = contentObj.content;
        
        let turndownService = new TurndownService();
        let md = turndownService.turndown(contentObj.content);
        document.getElementById('markdown-input').value = md;
        document.getElementById('markdown-result').innerHTML = contentObj.content;

        document.getElementById('contentLoadMsg').innerHTML =
          `<div class="alert alert-success">Content loaded successfully!</div>`;
        
        await alert("تم تحميل ملف المحتوى بنجاح، والمحتوى " + (contentObj.content ? "غير فارغ." : "فارغ."));
      } catch(e){
        console.error(e);
        alert("Error loading content file");
      }
    }

    async function saveContentChanges(){
      if(!currentContentFile){
        alert("No content file selected.");
        return;
      }
      let confirmSave = await confirm("Are you sure you want to save current content?");
      if(!confirmSave) return;
      let finalHtml = document.getElementById('markdown-result').innerHTML;
      let payload = {
        filePath: currentContentFile,
        sha: currentContentSha,
        newContent: finalHtml
      };
      try {
        let r = await fetch('/api/save-content-file', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        let j = await r.json();
        if(j.success){
          alert("Content saved!");
          originalContentHtml = finalHtml;
          currentContentSha = j.newSha; 
        } else {
          alert("Save failed: " + (j.error || ''));
        }
      } catch(e){
        console.error(e);
        alert("Error saving content file.");
      }
    }

    /****
     *   محرر الماركداون
     ****/
    let currentDirection = 'ltr';
    function detectTextDirection(text) {
      let arabicCount = 0, totalCount = 0;
      for (let char of text) {
        if (!char.match(/\s/)) {
          totalCount++;
          if (char.match(/[\u0600-\u06FF]/)) arabicCount++;
        }
      }
      if (totalCount === 0) return 'rtl';
      return (arabicCount / totalCount > 0.3) ? 'rtl' : 'ltr';
    }
    function convertMarkdownWithAlert(){
      convertMarkdown();
      alert("تمت عملية التحويل بنجاح!");
    }
    function convertMarkdown() {
      const markdownText = document.getElementById('markdown-input').value;
      const htmlContent = marked.parse(markdownText);
      document.getElementById('markdown-result').innerHTML = htmlContent;
      currentDirection = detectTextDirection(markdownText);
      document.getElementById('markdown-result').style.direction = currentDirection;
    }
    function printResult() {
      const resultDivContent = document.getElementById('markdown-result').innerHTML;
      const printWindow = window.open('about:blank', '_blank', 'width=800,height=600');
      const langAttr = (currentDirection === 'rtl') ? 'ar' : 'en';
      const styleContent = `
        @media print {
          body { -webkit-print-color-adjust: exact; }
        }
        body {
          font-family: 'Roboto', sans-serif;
          background: linear-gradient(135deg, #faf3e7, #eef7f6);
          margin: 0;
          padding: 0;
          color: #2c3e50;
        }
        #printResult { padding: 20px; }
      `;
      printWindow.document.write(`
        <html lang="${langAttr}" dir="${currentDirection}">
          <head>
            <meta charset="UTF-8" />
            <title>Print Result</title>
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css" rel="stylesheet" crossorigin="anonymous">
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
            <style>${styleContent}</style>
          </head>
          <body>
            <div id="printResult" style="direction: ${currentDirection};">
              ${resultDivContent}
            </div>
            <script>
              window.onload = function() { window.print(); }
            <\/script>
          </body>
        </html>
      `);
      printWindow.document.close();
    }

    /****
     * زر عائم لأدوات الـ triggers
     ****/
    let selectionInProgress = false;
    function handleToolsModalClick(){
      openToolsModal();
    }
    function openToolsModal(){
      document.getElementById('toolsOverlay').style.display = 'flex';
    }
    function closeToolsModal(){
      document.getElementById('toolsOverlay').style.display = 'none';
    }

    /****
     * زر عائم لإدارة/تعديل جميع الـ triggers المضافة
     ****/
    function openManageTriggersModal(){
      // فكرة: نجلب كل العناصر ذات الأكواد اللونية (trigger-link, trigger-video...)
      let overlay = document.getElementById('manageTriggersOverlay');
      let container = document.getElementById('insertedTriggersList');
      container.innerHTML = "";
      let htmlContent = document.getElementById('markdown-result').innerHTML;
      // سنحوّل النص إلى DOM حقيقي مؤقتًا
      let tempDiv = document.createElement('div');
      tempDiv.innerHTML = htmlContent;
      let triggers = tempDiv.querySelectorAll('.trigger-link, .trigger-video, .trigger-iframe, .trigger-qids, .trigger-text');

      if(triggers.length === 0){
        container.innerHTML = "<p>No triggers found in the current content.</p>";
      } else {
        triggers.forEach((el, idx) => {
          let li = document.createElement('div');
          li.style.border = "1px solid #ccc";
          li.style.padding = "5px";
          li.style.marginBottom = "5px";
          let contentShort = el.innerHTML;
          if(contentShort.length > 30) contentShort = contentShort.slice(0,30)+"...";
          li.innerHTML = `Trigger #${idx+1}: <code>${contentShort}</code> 
            <button class="btn btn-sm btn-danger ms-2" onclick="deleteTrigger(${idx})">Delete</button>
            <button class="btn btn-sm btn-info ms-2" onclick="editTrigger(${idx})">Edit</button>`;
          container.appendChild(li);
        });
      }

      overlay.style.display = 'flex';
    }
    function closeManageTriggersModal(){
      document.getElementById('manageTriggersOverlay').style.display = 'none';
    }

    function deleteTrigger(triggerIndex){
      // طريقة بسيطة: نقرأ الـ HTML النهائي، نحوله DOM، نجد جميع triggers ونحذف الـ triggerIndex
      let container = document.getElementById('markdown-result');
      let triggers = container.querySelectorAll('.trigger-link, .trigger-video, .trigger-iframe, .trigger-qids, .trigger-text');
      if(triggerIndex < triggers.length){
        triggers[triggerIndex].remove();
        // أعد فتح النافذة
        openManageTriggersModal();
      }
    }
    function editTrigger(triggerIndex){
      alert("Feature not fully implemented. Editing triggers is to be done manually or through re-insertion.").then(()=>{
        // يمكن إغلاق النافذة أو إعادة فتح
      });
    }

    let userSelectionRange = null;
    let currentTriggerType = null;

    /****
     * واجهة إضافة Trigger
     ****/
    function openTriggerForm(type){
      closeToolsModal();
      currentTriggerType = type;
      let overlay = document.getElementById('triggerFormOverlay');
      let titleEl = document.getElementById('triggerFormTitle');
      let contentEl = document.getElementById('triggerFormContent');
      overlay.style.display = 'flex';
      contentEl.innerHTML = "";

      let formHtml = "";
      formHtml = buildTriggerFormHtml(type);
      contentEl.innerHTML = formHtml;
    }
    function buildTriggerFormHtml(type){
      let heading = "";
      switch(type){
        case 'link': heading = "Add Link Trigger"; break;
        case 'video': heading = "Add Video Trigger"; break;
        case 'iframe': heading = "Add iFrame Trigger"; break;
        case 'qids': heading = "Add Q-ID(s) Trigger"; break;
        case 'text': heading = "Add Custom Text/Tag Trigger"; break;
      }
      document.getElementById('triggerFormTitle').textContent = heading;

      return `
        <div class="mb-2">
          <label>Description (optional):</label>
          <input type="text" id="triggerDesc" class="form-control" placeholder="Write any description...">
        </div>
        <div class="mb-2">
          <button class="btn btn-sm btn-info" onclick="startSelectionMode()">Select Text Range</button>
          <small class="text-muted">Then choose position (before, after, inside)</small>
        </div>
        <div class="mb-2">
          <label>Insert Position:</label>
          <select id="triggerPosition" class="form-select">
            <option value="before">Before</option>
            <option value="after">After</option>
            <option value="inside">Inside</option>
          </select>
        </div>
        ${ triggerInputField(type) }
        <button class="btn btn-primary w-100 mt-2" onclick="applyTriggerInsertion()">تم</button>
      `;
    }
    function triggerInputField(type){
      switch(type){
        case 'link':
          return `
            <div class="mb-2">
              <label>Link URL:</label>
              <input type="text" id="triggerLinkUrl" class="form-control" placeholder="https://...">
            </div>
          `;
        case 'video':
          return `
            <div class="mb-2">
              <label>Video URL:</label>
              <input type="text" id="triggerLinkUrl" class="form-control" placeholder="https://...">
            </div>
          `;
        case 'iframe':
          return `
            <div class="mb-2">
              <label>iFrame embed URL (YouTube, etc.):</label>
              <input type="text" id="triggerLinkUrl" class="form-control" placeholder="https://www.youtube.com/embed/VIDEO_ID">
            </div>
          `;
        case 'qids':
          return `
            <div class="mb-2">
              <label>Q-IDs (separated by space):</label>
              <input type="text" id="triggerLinkUrl" class="form-control" placeholder="e.g. anat-lowe-q77 anat-lowe-q80">
            </div>
          `;
        case 'text':
          return `
            <div class="mb-2">
              <label>Custom HTML / text:</label>
              <textarea id="triggerLinkUrl" class="form-control"></textarea>
            </div>
          `;
      }
      return "";
    }
    function closeTriggerForm(){
      document.getElementById('triggerFormOverlay').style.display = 'none';
    }

    function startSelectionMode(){
      document.getElementById('triggerFormOverlay').style.display = 'none';
      alert("حدد النص في خانة الماركداون ثم اضغط زر Tools & Triggers من جديد لإتمام العملية.");
      selectionInProgress = true;
    }

    function applyTriggerInsertion(){
      if(!userSelectionRange){
        alert("No selection range set. Please select text range first.");
        return;
      }
      let desc = document.getElementById('triggerDesc') ? document.getElementById('triggerDesc').value : "";
      let pos = document.getElementById('triggerPosition') ? document.getElementById('triggerPosition').value : "before";
      let valEl = document.getElementById('triggerLinkUrl');
      let val = valEl ? valEl.value || "" : "";

      let ta = document.getElementById('markdown-input');
      let textVal = ta.value;
      let beforeText = textVal.slice(0, userSelectionRange.start);
      let selectedText = textVal.slice(userSelectionRange.start, userSelectionRange.end);
      let afterText = textVal.slice(userSelectionRange.end);

      if(!selectedText){
        selectedText = "TRIGGERED_TEXT";
      }

      let finalInsert = buildTriggerMarkup(currentTriggerType, pos, selectedText, desc, val);

      let replaced = "";
      if(pos==="before"){
        replaced = beforeText + finalInsert + selectedText + afterText;
      } else if(pos==="after"){
        replaced = beforeText + selectedText + finalInsert + afterText;
      } else {
        // inside → نستبدل النص بنفسه، لكن مع إضافة/دمج trigger
        // إن كان النص نفسه يحتوي سابقًا على سبان trigger، ندمج
        replaced = beforeText + integrateInsideTrigger(selectedText, desc, val, currentTriggerType) + afterText;
      }

      ta.value = replaced;
      convertMarkdown();
      userSelectionRange = null;
      closeTriggerForm();
    }

    /** تلوين الأنواع */
    const triggerClassMap = {
      link: "trigger-link",
      video: "trigger-video",
      iframe: "trigger-iframe",
      qids: "trigger-qids",
      text: "trigger-text"
    };
    function buildTriggerMarkup(type, pos, text, desc, val){
      // للـ before/after → عنصر block مثل <div> أو <video> إلخ
      let cls = triggerClassMap[type] || "trigger-text";
      switch(type){
        case 'link':
          return `[${desc || text}]( ${val || '#'} )`; // ماركداون
        case 'video':
          return `\n<video class="${cls}" src="${val}" controls>${desc}</video>\n`;
        case 'iframe':
          return `\n<div class="${cls}"><h4>${desc}</h4><iframe src="${val}" width="560" height="315" frameborder="0" allowfullscreen></iframe></div>\n`;
        case 'qids':
          let splitted = val.split(/\s+/).join(", ");
          return `<span class="${cls}" data-qids="${splitted}">${desc || text}</span>`;
        case 'text':
          return `<span class="${cls}" data-desc="${desc || ''}">${val}</span>`;
      }
      return `<span class="${cls}">${text}</span>`;
    }

    function integrateInsideTrigger(text, desc, val, type){
      let cls = triggerClassMap[type] || "trigger-text";
      // إذا كان النص يضم عناصر HTML → قد يكون المستخدم اختار نصًا فيه سبان
      // سنبسط: نغلف النص كاملًا في سبان (أو ندمج) مع data-x لتمكين تعدد الأدوات
      // initial approach: <span class="cls" data-something>text</span> + desc
      // لكن يريد: النص يبقى كما هو. حين يضغط المستخدم عليه تظهر description + triggers...
      // We'll embed multiple triggers by storing them as data- attributes (like data-lnk=..., data-vid=..., etc.)
      // For simplicity: We'll wrap the original text in a <span> if not wrapped. If wrapped, append new attribute.
      
      // هل يحوي النص <span ...>؟
      if(text.match(/<span[^>]*>/)){
        // النص فيه تاغ أصلاً. نحاول ضم desc + val
        // hack: just add a sub <span> for the new trigger
        return `<span class="${cls}" data-extra-desc="${desc || ''}" data-extra-val="${val}">${text}</span>`;
      } else {
        // ببساطة نغلّف النص بسبان
        return `<span class="${cls}" data-desc="${desc || ''}" data-val="${val}">${text}</span>`;
      }
    }

    /****
     * إدارة الأدوات
     ****/
    function openManageTriggersModal(){
      let overlay = document.getElementById('manageTriggersOverlay');
      let container = document.getElementById('insertedTriggersList');
      container.innerHTML = "";
      let htmlContent = document.getElementById('markdown-result').innerHTML;
      let tempDiv = document.createElement('div');
      tempDiv.innerHTML = htmlContent;
      let triggers = tempDiv.querySelectorAll('.trigger-link, .trigger-video, .trigger-iframe, .trigger-qids, .trigger-text');
      if(triggers.length === 0){
        container.innerHTML = "<p>No triggers found in the current content.</p>";
      } else {
        triggers.forEach((el, idx) => {
          let li = document.createElement('div');
          li.style.border = "1px solid #ccc";
          li.style.padding = "5px";
          li.style.marginBottom = "5px";
          let contentShort = el.outerHTML;
          if(contentShort.length > 80) contentShort = contentShort.slice(0,80)+"...";
          li.innerHTML = `Trigger #${idx+1}: <code>${contentShort}</code>
            <button class="btn btn-sm btn-danger ms-2" onclick="deleteTrigger(${idx})">Delete</button>
            <button class="btn btn-sm btn-info ms-2" onclick="editTrigger(${idx})">Edit</button>`;
          container.appendChild(li);
        });
      }
      overlay.style.display = 'flex';
    }

    function closeManageTriggersModal(){
      document.getElementById('manageTriggersOverlay').style.display = 'none';
    }

    function deleteTrigger(triggerIndex){
      let container = document.getElementById('markdown-result');
      let triggers = container.querySelectorAll('.trigger-link, .trigger-video, .trigger-iframe, .trigger-qids, .trigger-text');
      if(triggerIndex < triggers.length){
        triggers[triggerIndex].remove();
        openManageTriggersModal();
      }
    }

    function editTrigger(triggerIndex){
      alert("Feature not fully implemented.").then(()=>{
        // placeholder for real edit
      });
    }
  </script>
</body>
</html>
