<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel - Manage Topics & Content</title>
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
  <!-- Ù…ÙƒØªØ¨Ø© Marked.js Ù„ØªØ­ÙˆÙŠÙ„ Markdown Ø¥Ù„Ù‰ HTML -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <!-- Ù…ÙƒØªØ¨Ø© Turndown.js Ù„ØªØ­ÙˆÙŠÙ„ HTML Ø¥Ù„Ù‰ Markdown Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
  <script src="https://cdn.jsdelivr.net/npm/turndown/dist/turndown.js"></script>
  <style>
    body {
      background: linear-gradient(135deg, #f5f7fa, #c3cfe2);
      font-family: 'Roboto', sans-serif;
      padding: 20px 0;
    }
    .container-custom {
      max-width: 1200px;
      background-color: #fff;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      margin: auto;
    }
    h1 {
      text-align: center;
      margin-bottom: 30px;
      color: #343a40;
      font-weight: 600;
    }
    .card-section {
      margin-bottom: 30px;
      border-radius: 15px;
      overflow: hidden;
    }
    .card-section .card-header {
      background-color: #343a40;
      color: #fff;
      font-size: 1.25em;
    }
    .btn-custom {
      width: 100%;
      padding: 12px;
      font-size: 1.1em;
      border-radius: 50px;
      transition: all 0.3s ease;
    }
    .btn-custom:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
    }
    /* Tree List */
    .topic-node {
      border: 1px solid #dee2e6;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 15px;
      background-color: #f8f9fa;
    }
    .topic-node .node-title {
      font-weight: bold;
      color: #495057;
    }
    .topic-node .btn-group-sm > .btn {
      margin-right: 5px;
    }
    .sub-node {
      margin-left: 20px;
      margin-top: 10px;
      border-left: 2px dashed #ccc;
      padding-left: 10px;
    }
    /* Ù…Ø­Ø±Ø± Ø§Ù„Ù…Ø§Ø±ÙƒØ¯Ø§ÙˆÙ† + Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø© */
    #markdown-input {
      border-radius: 15px;
      overflow: auto;
      resize: none;
      height: 300px;
      width: 100%;
      cursor: grab;
    }
    #markdown-input:active {
      cursor: grabbing;
    }
    #markdown-result {
      margin-top: 20px;
      background-color: #fff;
      padding: 20px;
      border-radius: 15px;
      border: 1px solid #ddd;
      min-height: 200px;
    }
    /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¹Ø§Ø¦Ù…Ø© */
    #floatManageTriggersBtn {
      display: none !important; /* Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ±ÙŠØºØ±Ø² */
    }
    #floatToolsBtn {
      display: none !important; /* Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ±ÙŠØºØ±Ø² */
    }
    #floatScrollBtn {
      position: fixed;
      width: 50px;
      height: 50px;
      background: #4a90e2;
      color: #fff;
      border: none;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      cursor: pointer;
      z-index: 999;
      top: 50%;
      right: 30px;
      transform: translateY(40%);
    }
    #floatScrollBtn:hover {
      opacity: 0.8;
    }

    .modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    .modal-box {
      background: #fff;
      border-radius: 8px;
      padding: 20px;
      max-width: 500px;
      width: 90%;
      text-align: center;
    }
    .modal-box h3 {
      margin-bottom: 20px;
      font-size: 1.1rem;
      color: #333;
    }
    .modal-buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 10px;
    }
    /* Ù…ØªÙØ±Ù‚Ø§Øª */
    .upload-progress {
      margin-top: 10px;
      display: none;
    }
    .uploaded-images-list {
      margin-top: 10px;
    }
    .uploaded-images-list li {
      margin-bottom: 5px;
    }
    .alert-success {
      margin-top: 10px;
    }
    .selection-guides {
      position: absolute;
      border: 2px dashed red;
      pointer-events: none;
      display: none;
    }
    #selectionDonePrompt {
      display: none;
      margin-top: 10px;
      text-align: center;
    }

    /* Ø´ÙƒÙ„ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„ØªØ±ÙŠØºØ± Ø¥Ù† Ø£Ø±Ø¯Øª ØªÙˆØ¶ÙŠØ­Ø§Ù‹ */
    .trigger-button {
      border: none;
      background: #f1f1f1;
      border-radius: 8px;
      cursor: pointer;
      width: 40px; height: 40px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin: 0 5px;
      padding: 0;
    }
    .trigger-button:hover {
      background: #ddd;
    }
    /* Ù…Ø«Ø§Ù„ Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ù…Ø®ØªÙ„ÙØ© Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø© */
    .video-trigger::before {
      content: "ğŸ¬";
      font-size: 18px;
    }
    .image-trigger::before {
      content: "ğŸ“·";
      font-size: 18px;
    }
    .question-trigger::before {
      content: "â“";
      font-size: 18px;
    }
    .link-trigger::before {
      content: "ğŸ”—";
      font-size: 18px;
    }
    .text-trigger::before {
      content: "ğŸ“";
      font-size: 18px;
    }
    .iframe-trigger::before {
      content: "ğŸŒ";
      font-size: 18px;
    }
    .multi-trigger::before {
      content: "ğŸ”";
      font-size: 18px;
    }
  </style>
</head>
<body>
  <div class="container-custom">
    <h1><i class="bi bi-journal-text"></i> Admin Panel - Manage Topics & Content</h1>

    <!-- Manage Topics Section -->
    <div class="card card-section">
      <div class="card-header">Manage Topics (exp_topics.json)</div>
      <div class="card-body">
        <div class="mb-3">
          <button class="btn btn-primary btn-custom" onclick="loadExpTopics()">Load exp_topics.json</button>
        </div>

        <div id="topicsTree"></div>

        <hr>

        <!-- Add New Topic/Subtopic Form -->
        <div class="row g-2 align-items-center">
          <div class="col-md-4">
            <input type="text" id="newNodeTitle" class="form-control" placeholder="Title...">
          </div>
          <div class="col-md-4">
            <!-- Ø§Ø®ØªÙŠØ§Ø± Ø¥Ù† ÙƒØ§Ù† ÙØ±Ø¹ (Branch) Ø£Ù… Ù…Ø­ØªÙˆÙ‰ (Content) -->
            <select id="newNodeType" class="form-select">
              <option value="branch">Branch</option>
              <option value="content">Content</option>
            </select>
          </div>
          <div class="col-md-4">
            <!-- Ø²Ø± Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹/Ø§Ù„ÙØ±Ø¹/Ø§Ù„Ù…Ø­ØªÙˆÙ‰ -->
            <button class="btn btn-success btn-custom" onclick="addNode()">Add Node</button>
          </div>
        </div>

        <!-- Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„Ø°ÙŠ Ù†Ø¶ÙŠÙÙ‡ ØªØ­ØªÙ‡ (Ø¬Ø°Ø± Ø£Ù… Ø¯Ø§Ø®Ù„ Ø£Ø­Ø¯Ù‡Ù…) -->
        <div class="row g-2 mt-3 align-items-center">
          <div class="col-md-12">
            <label>Select where to add:</label>
            <select id="parentSelect" class="form-select"></select>
          </div>
        </div>

        <hr>
        <div class="mt-3">
          <button class="btn btn-primary btn-custom" onclick="saveExpTopics()">Save All Changes</button>
        </div>
      </div>
    </div>
    <!-- END Manage Topics Section -->

    <!-- Manage Content Section -->
    <div class="card card-section">
      <div class="card-header">Manage Content (files with dataFile)</div>
      <div class="card-body">
        <!-- Dropdown Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„ØªÙŠ ØªÙ… ØªØ¹Ø±ÙŠÙÙ‡Ø§ ÙƒÙ…Ø­ØªÙˆÙ‰ ÙÙ‚Ø· -->
        <div class="mb-3">
          <select id="contentNodesSelect" class="form-select">
            <option value="">-- Select Content Node --</option>
          </select>
        </div>
        <div class="mb-3">
          <button class="btn btn-primary btn-custom" onclick="loadContentFile()">Load Content File</button>
        </div>
        <div id="contentLoadMsg"></div>

        <hr>

        <!-- Ù…Ø­Ø±Ø± Ø§Ù„Ù…Ø§Ø±ÙƒØ¯Ø§ÙˆÙ† -->
        <label for="markdown-input" class="form-label">Markdown Editor (drag to scroll):</label>
        <textarea class="form-control" id="markdown-input"></textarea>

        <!-- Ù…Ø³Ø§Ø­Ø© Ø±Ø³Ø§Ù„Ø© "Finished Selection?" Ù…Ø¹ Ø²Ø±ÙŠ Yes/No -->
        <div id="selectionDonePrompt">
          <div class="bg-light p-3 border rounded">
            <span>Finished text selection?</span>
            <button class="btn btn-sm btn-success ms-2" onclick="selectionDoneYes()">Yes</button>
            <button class="btn btn-sm btn-danger ms-2" onclick="selectionDoneNo()">No</button>
          </div>
        </div>

        <!-- Ø²Ø± ÙˆØ§Ø­Ø¯ Ù„ØªØ­ÙˆÙŠÙ„ -->
        <div class="row g-2 mt-2">
          <div class="col-md-12">
            <button class="btn btn-primary w-100 btn-custom" onclick="convertMarkdown()">
              <i class="bi bi-arrow-left-right"></i> Convert
            </button>
          </div>
        </div>

        <!-- Ù…Ù†Ø·Ù‚Ø© Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø© -->
        <div id="markdown-result" style="direction: ltr; margin-top:20px;"></div>

        <hr>

        <!-- Ø²Ø± Ø­ÙØ¸ & Ø²Ø± Ø·Ø¨Ø§Ø¹Ø© -->
        <div class="row g-2">
          <div class="col-md-6">
            <button class="btn btn-info btn-custom" onclick="printResult()">Print / PDF</button>
          </div>
          <div class="col-md-6">
            <button class="btn btn-success btn-custom" onclick="saveContentChanges()">Save Content</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Ø²Ø± Ø¹Ø§Ø¦Ù… Ù„Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„Ù€ Tools & Triggers Ø§Ù„Ù…Ø¯Ø®Ù„Ø© (Ù…Ø®ÙÙŠ) -->
  <button id="floatManageTriggersBtn" onclick="openManageTriggersModal()">âš’</button>
  <!-- Ø²Ø± Ø¹Ø§Ø¦Ù… Ù„Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø®ØªÙ„ÙØ© (triggers, video, link, question-id ...) (Ù…Ø®ÙÙŠ)-->
  <button id="floatToolsBtn" onclick="handleToolsModalClick()">âš™</button>
  <!-- Ø²Ø± Ø¹Ø§Ø¦Ù… Ù„Ù„ØªÙ…Ø±ÙŠØ± -->
  <button id="floatScrollBtn" onclick="toggleScroll()">â†“</button>

  <!-- Ù†Ø¸Ø§Ù… Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© (modal) -->
  <div class="modal-overlay" id="alertOverlay">
    <div class="modal-box">
      <h3 id="alertMsg"></h3>
      <div class="modal-buttons">
        <button class="btn btn-primary" id="alertOkBtn">OK</button>
      </div>
    </div>
  </div>
  <div class="modal-overlay" id="confirmOverlay">
    <div class="modal-box">
      <h3 id="confirmMsg"></h3>
      <div class="modal-buttons">
        <button class="btn btn-primary" id="confirmYesBtn">Yes</button>
        <button class="btn btn-danger" id="confirmNoBtn">No</button>
      </div>
    </div>
  </div>
  <div class="modal-overlay" id="promptOverlay">
    <div class="modal-box">
      <h3 id="promptMsg"></h3>
      <input type="text" id="promptInput" class="form-control mb-3">
      <div class="modal-buttons">
        <button class="btn btn-primary" id="promptOkBtn">OK</button>
        <button class="btn btn-secondary" id="promptCancelBtn">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Ù†Ø§ÙØ°Ø© Ù…Ù†Ø¨Ø«Ù‚Ø© Ø®Ø§ØµØ© Ø¨Ù€ Tools & Triggers (Ù…Ø®ÙÙŠØ©) -->
  <div class="modal-overlay" id="toolsOverlay">
    <div class="modal-box" id="toolsModalBox">
      <h3>Tools & Triggers</h3>
      <div class="d-grid gap-2">
        <button class="btn btn-outline-secondary" onclick="openTriggerForm('link')">Add Link</button>
        <button class="btn btn-outline-secondary" onclick="openTriggerForm('video')">Add Video</button>
        <button class="btn btn-outline-secondary" onclick="openTriggerForm('iframe')">Add iFrame</button>
        <button class="btn btn-outline-secondary" onclick="openTriggerForm('qids')">Add Q-ID(s)</button>
        <button class="btn btn-outline-secondary" onclick="openTriggerForm('text')">Add Custom Text/Tag</button>
        <button class="btn btn-outline-secondary" onclick="openImageUploader()">Upload Image(s)</button>
      </div>
      <div class="modal-buttons mt-2">
        <button class="btn btn-secondary" onclick="closeToolsModal()">Close</button>
      </div>
    </div>
  </div>

  <!-- Ù†Ø§ÙØ°Ø© Ù…Ù†Ø¨Ø«Ù‚Ø© Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø¯Ø®Ù„Ø© (Ù…Ø®ÙÙŠØ©) -->
  <div class="modal-overlay" id="manageTriggersOverlay">
    <div class="modal-box" id="manageTriggersModalBox">
      <h3>Manage Inserted Triggers</h3>
      <div id="insertedTriggersList" class="mb-3" style="text-align:left; max-height:300px; overflow:auto;"></div>
      <div class="modal-buttons">
        <button class="btn btn-secondary" onclick="closeManageTriggersModal()">Close</button>
      </div>
    </div>
  </div>

  <!-- Ù†Ø§ÙØ°Ø© Ù…Ù†Ø¨Ø«Ù‚Ø© Ù„Ø®Ø·ÙˆØ§Øª Ø¥Ø¶Ø§ÙØ© Trigger Ù…Ø­Ø¯Ø¯ (Ù…Ø®ÙÙŠØ©) -->
  <div class="modal-overlay" id="triggerFormOverlay">
    <div class="modal-box" style="text-align: left;">
      <h3 id="triggerFormTitle">Add Link</h3>
      <div id="triggerFormContent"></div>
      <div class="modal-buttons">
        <button class="btn btn-secondary" onclick="closeTriggerForm()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Ù†Ø§ÙØ°Ø© Ù…Ù†Ø¨Ø«Ù‚Ø© Ù„Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± (Ù…Ø®ÙÙŠØ©) -->
  <div class="modal-overlay" id="imageUploadOverlay">
    <div class="modal-box" style="text-align: left;">
      <h3>Upload or Insert Image</h3>
      <div>
        <!-- Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø© Ù…Ù† Ø§Ù„Ø¬Ù‡Ø§Ø² -->
        <label class="form-label">Upload from device:</label>
        <input type="file" id="localImageFile" class="form-control" multiple>
        <button class="btn btn-success w-100 mt-2" onclick="uploadLocalImages()">Upload Selected</button>
        <div class="upload-progress" id="uploadProgress">
          <div class="progress mt-2">
            <div class="progress-bar" role="progressbar" style="width: 0%;" id="uploadProgressBar">0%</div>
          </div>
        </div>
        <hr>
        <!-- Ø£Ùˆ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© Ù…Ø¨Ø§Ø´Ø± -->
        <label class="form-label">Or use image link:</label>
        <input type="text" id="imageLinkInput" class="form-control" placeholder="https://...">
        <button class="btn btn-primary w-100 mt-2" onclick="insertImageLink()">Insert Link</button>
      </div>
      <hr>
      <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…Ø±ÙÙˆØ¹Ø© Ù…Ø¹ Ø²Ø± Ø§Ù„Ø­Ø°Ù -->
      <div>
        <h5>Uploaded Images:</h5>
        <ul class="uploaded-images-list" id="uploadedImagesList"></ul>
      </div>
      <div class="modal-buttons">
        <button class="btn btn-secondary" onclick="closeImageUploader()">Close</button>
      </div>
    </div>
  </div>

  <div class="selection-guides" id="selectionBox"></div>

  <!-- Bootstrap 5 JS Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

  <script>
    /****
     *            Ù†Ø¸Ø§Ù… Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© (Alert, Confirm, Prompt)
     ****/
    let alertOverlay = document.getElementById('alertOverlay');
    let alertMsg = document.getElementById('alertMsg');
    let alertOkBtn = document.getElementById('alertOkBtn');

    let confirmOverlay = document.getElementById('confirmOverlay');
    let confirmMsg = document.getElementById('confirmMsg');
    let confirmYesBtn = document.getElementById('confirmYesBtn');
    let confirmNoBtn = document.getElementById('confirmNoBtn');

    let promptOverlay = document.getElementById('promptOverlay');
    let promptMsg = document.getElementById('promptMsg');
    let promptInput = document.getElementById('promptInput');
    let promptOkBtn = document.getElementById('promptOkBtn');
    let promptCancelBtn = document.getElementById('promptCancelBtn');

    function customAlert(message) {
      return new Promise(resolve => {
        alertMsg.textContent = message;
        alertOverlay.style.display = 'flex';
        alertOkBtn.onclick = () => {
          alertOverlay.style.display = 'none';
          resolve();
        };
      });
    }
    function customConfirm(message) {
      return new Promise(resolve => {
        confirmMsg.textContent = message;
        confirmOverlay.style.display = 'flex';
        confirmYesBtn.onclick = () => {
          confirmOverlay.style.display = 'none';
          resolve(true);
        };
        confirmNoBtn.onclick = () => {
          confirmOverlay.style.display = 'none';
          resolve(false);
        };
      });
    }
    function customPrompt(message, defVal) {
      return new Promise(resolve => {
        promptMsg.textContent = message;
        promptInput.value = defVal || '';
        promptOverlay.style.display = 'flex';
        promptOkBtn.onclick = () => {
          let val = promptInput.value;
          promptOverlay.style.display = 'none';
          resolve(val);
        };
        promptCancelBtn.onclick = () => {
          promptOverlay.style.display = 'none';
          resolve(null);
        };
      });
    }

    // Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø¯ÙˆØ§Ù„ alert/confirm/prompt Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©:
    window.alert = async function(msg) { await customAlert(msg); };
    window.confirm = async function(msg) { return customConfirm(msg); };
    window.prompt = async function(msg, defVal) { return customPrompt(msg, defVal); };

    /****
     *  ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø³Ø­Ø¨ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù€ textarea Ù„Ù„ØªÙ…Ø±ÙŠØ±
     ****/
    (function enableDragScroll(){
      const mdInput = document.getElementById('markdown-input');
      let isDown = false, startY, scrollTop;
      mdInput.addEventListener('mousedown', e => {
        isDown = true;
        startY = e.pageY - mdInput.offsetTop;
        scrollTop = mdInput.scrollTop;
      });
      mdInput.addEventListener('mouseleave', () => { isDown = false; });
      mdInput.addEventListener('mouseup', () => { isDown = false; });
      mdInput.addEventListener('mousemove', e => {
        if(!isDown) return;
        e.preventDefault();
        const y = e.pageY - mdInput.offsetTop;
        const walk = (y - startY) * 1.5;
        mdInput.scrollTop = scrollTop - walk;
      });
    })();

    let scrollDown = true;
    function toggleScroll(){
      const btn = document.getElementById('floatScrollBtn');
      if(scrollDown){
        window.scrollTo({top: document.body.scrollHeight, behavior: 'smooth'});
        btn.textContent = 'â†‘';
        scrollDown = false;
      } else {
        window.scrollTo({top: 0, behavior: 'smooth'});
        btn.textContent = 'â†“';
        scrollDown = true;
      }
    }

    /****
     * Ø¥Ø¯Ø§Ø±Ø© exp_topics.json
     ****/
    let expTopics = null;
    let topicsSha = null;

    async function loadExpTopics(){
      try {
        const res = await fetch('/api/get-exp-topics');
        const data = await res.json();
        if(!data.success) {
          alert("Failed to load exp_topics.json: " + (data.error || ''));
          return;
        }
        expTopics = data.content;
        topicsSha = data.sha;
        renderTopicsTree();
        fillParentSelect();
        loadContentFileList();
        await alert("exp_topics.json Loaded Successfully!");
      } catch(e){
        console.error(e);
        alert("Error loading exp_topics.json");
      }
    }

    async function saveExpTopics(){
      if(!expTopics){
        alert("No data loaded yet.");
        return;
      }
      let confirmSave = await confirm("Are you sure you want to save changes to exp_topics.json?");
      if(!confirmSave) return;
      try {
        let body = {
          content: expTopics,
          sha: topicsSha
        };
        const res = await fetch('/api/save-exp-topics', {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify(body)
        });
        const j = await res.json();
        if(j.success){
          alert("Saved successfully!");
        } else {
          alert("Save failed: " + (j.error || ''));
        }
      } catch(e){
        console.error(e);
        alert("Error saving topics.");
      }
    }

    function renderTopicsTree(){
      const treeContainer = document.getElementById('topicsTree');
      treeContainer.innerHTML = '';
      if(!expTopics || !expTopics.topics) return;

      expTopics.topics.forEach((topic, index) => {
        const node = createNodeElement(topic, ['topics', index], 0);
        treeContainer.appendChild(node);
      });
    }

    function createNodeElement(nodeObj, path, level){
      let div = document.createElement('div');
      div.className = "topic-node";
      let label = document.createElement('div');
      label.className = "node-title mb-2";

      let nodeTitle = nodeObj.title || "Untitled";
      label.textContent = nodeTitle;

      let btnGroup = document.createElement('div');
      btnGroup.className = "btn-group-sm";

      let upBtn = document.createElement('button');
      upBtn.className = "btn btn-secondary";
      upBtn.textContent = "â–²";
      upBtn.onclick = () => moveNodeUp(path);
      btnGroup.appendChild(upBtn);

      let downBtn = document.createElement('button');
      downBtn.className = "btn btn-secondary";
      downBtn.textContent = "â–¼";
      downBtn.onclick = () => moveNodeDown(path);
      btnGroup.appendChild(downBtn);

      let editBtn = document.createElement('button');
      editBtn.className = "btn btn-warning";
      editBtn.textContent = "Edit";
      editBtn.onclick = () => editNodeTitle(path);
      btnGroup.appendChild(editBtn);

      let delBtn = document.createElement('button');
      delBtn.className = "btn btn-danger";
      delBtn.textContent = "Delete";
      delBtn.onclick = () => deleteNode(path);
      btnGroup.appendChild(delBtn);

      label.appendChild(btnGroup);
      div.appendChild(label);

      if(nodeObj.subtopics && Array.isArray(nodeObj.subtopics)){
        nodeObj.subtopics.forEach((subtopic, i) => {
          let subDiv = document.createElement('div');
          subDiv.className = "sub-node";
          let subpath = [...path, 'subtopics', i];
          let element = createNodeElement(subtopic, subpath, level+1);
          subDiv.appendChild(element);
          div.appendChild(subDiv);
        });
      }
      return div;
    }

    function moveNodeUp(path){
      let { parentArray, indexInArray } = getParentArrayAndIndex(path);
      if(indexInArray > 0){
        let temp = parentArray[indexInArray];
        parentArray[indexInArray] = parentArray[indexInArray - 1];
        parentArray[indexInArray - 1] = temp;
        renderTopicsTree();
        fillParentSelect();
        loadContentFileList();
      }
    }
    function moveNodeDown(path){
      let { parentArray, indexInArray } = getParentArrayAndIndex(path);
      if(indexInArray < parentArray.length - 1){
        let temp = parentArray[indexInArray];
        parentArray[indexInArray] = parentArray[indexInArray + 1];
        parentArray[indexInArray + 1] = temp;
        renderTopicsTree();
        fillParentSelect();
        loadContentFileList();
      }
    }
    function getParentArrayAndIndex(path){
      let parentRef = expTopics;
      for(let i = 0; i < path.length - 1; i++){
        parentRef = parentRef[path[i]];
      }
      let indexInArray = path[path.length - 1];
      return { parentArray: parentRef, indexInArray };
    }

    async function editNodeTitle(path){
      let { parentArray, indexInArray } = getParentArrayAndIndex(path);
      let node = parentArray[indexInArray];
      let oldTitle = node.title || '';
      let newTitle = await prompt("Enter new title:", oldTitle);
      if(newTitle !== null){
        newTitle = newTitle.trim();
        if(newTitle === "") return;
        node.title = newTitle;
        if(node.dataFile){
          await renameContentFile(path, node);
        }
        renderTopicsTree();
        fillParentSelect();
        loadContentFileList();
      }
    }

    function getTitlesChain(path){
      let chain = [];
      function recurse(nodeList, currentPath){
        for(let i=0; i<nodeList.length; i++){
          let nodeObj = nodeList[i];
          let p = [...currentPath, i];
          if(JSON.stringify(p) === JSON.stringify(path)){
            chain.push(nodeObj.title);
            return true;
          }
          if(nodeObj.subtopics && nodeObj.subtopics.length>0){
            let subPath = [...currentPath, i, 'subtopics'];
            if(recurse(nodeObj.subtopics, subPath)) {
              chain.unshift(nodeObj.title);
              return true;
            }
          }
        }
        return false;
      }
      function outer(){
        for(let i=0; i<expTopics.topics.length; i++){
          let nodeObj = expTopics.topics[i];
          if(JSON.stringify(['topics', i]) === JSON.stringify(path)){
            chain.push(nodeObj.title);
            return true;
          }
          if(nodeObj.subtopics && nodeObj.subtopics.length>0){
            let subPath = ['topics', i, 'subtopics'];
            if(recurse(nodeObj.subtopics, subPath)){
              chain.unshift(nodeObj.title);
              return true;
            }
          }
        }
      }
      outer();
      return chain;
    }
    async function renameContentFile(path, node){
      try {
        let oldPath = node.dataFile;
        let parentPath = path.slice(0, -1);
        let newFileName = "";

        let chainForParent = getTitlesChain(parentPath.slice(0, -1));
        let parentChain = chainForParent.map(t => t.replace(/\s+/g, '_').replace(/[^\w_\-]/g, '').toLowerCase()).join('_');
        let childPart = node.title.replace(/\s+/g, '_').replace(/[^\w_\-]/g, '').toLowerCase();
        if(parentChain){
          newFileName = parentChain + "_" + childPart + ".json";
        } else {
          newFileName = childPart + ".json";
        }

        let body = {
          oldPath,
          newPath: "exp_data/" + newFileName
        };
        let fullChain = getTitlesChain(path);
        if(fullChain.length > 1){
          let newTitleStr = fullChain.join(" - ");
          body.newTitle = newTitleStr;
        } else {
          body.newTitle = node.title;
        }

        let renameReq = await fetch('/api/rename-file', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        let renameRes = await renameReq.json();
        if(!renameRes.success){
          await alert("Could not rename file: " + (renameRes.error || ''));
          return;
        }
        node.dataFile = newFileName;
      } catch(e){
        console.error(e);
        alert("Error in renameContentFile: " + e.toString());
      }
    }

    async function deleteNode(path){
      let { parentArray, indexInArray } = getParentArrayAndIndex(path);
      let node = parentArray[indexInArray];

      if(node.dataFile){
        let confirmDel = await confirm("This is a content node. Deleting will also remove its file from GitHub. Proceed?");
        if(!confirmDel) return;
        await fetch(`/api/delete-file?filePath=${encodeURIComponent("exp_data/"+node.dataFile)}`, {
          method: 'DELETE'
        }).then(r => r.json()).then(resp => {
          if(!resp.success){
            console.warn("Could not delete file from GitHub:", resp.error);
          }
        }).catch(err => console.error(err));
      } else {
        let confirmDel = await confirm("Delete this branch (and all sub-branches)?");
        if(!confirmDel) return;
        await deleteNestedDataFiles(node);
      }
      parentArray.splice(indexInArray, 1);
      renderTopicsTree();
      fillParentSelect();
      loadContentFileList();
    }

    async function deleteNestedDataFiles(node){
      if(!node) return;
      if(node.subtopics && Array.isArray(node.subtopics)){
        for(let st of node.subtopics){
          if(st.dataFile){
            await fetch(`/api/delete-file?filePath=${encodeURIComponent("exp_data/"+st.dataFile)}`, { method: 'DELETE' })
              .then(r=>r.json()).then(resp=>{
                if(!resp.success){
                  console.warn("Could not delete file from GitHub (nested):", resp.error);
                }
              }).catch(err=>console.error(err));
          }
          if(st.subtopics){
            await deleteNestedDataFiles(st);
          }
        }
      }
    }

    async function addNode(){
      if(!expTopics) {
        alert("Load exp_topics.json first!");
        return;
      }
      let nodeTitle = document.getElementById('newNodeTitle').value.trim();
      if(!nodeTitle){
        alert("Please enter a title.");
        return;
      }
      let nodeType = document.getElementById('newNodeType').value;
      let parentVal = document.getElementById('parentSelect').value;
      let newObj = { title: nodeTitle };

      if(nodeType === "branch"){
        newObj.subtopics = [];
      } else {
        let fileName = generateFileNameForContent(parentVal, nodeTitle);
        let newJsonTitle = generateTitleFieldForContent(parentVal, nodeTitle);

        let createReq = await fetch('/api/add-file', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ fileName, newJsonTitle })
        });
        let createRes = await createReq.json();
        if(createRes.success){
          newObj.dataFile = fileName;
        } else {
          alert("Could not create file for content. " + (createRes.error||''));
          return;
        }
      }

      if(parentVal === 'root'){
        expTopics.topics.push(newObj);
      } else {
        let { parentArray, indexInArray } = getParentArrayAndIndex(JSON.parse(parentVal));
        let parentNode = parentArray[indexInArray];
        if(!parentNode.subtopics) parentNode.subtopics = [];
        parentNode.subtopics.push(newObj);
      }

      document.getElementById('newNodeTitle').value = '';
      document.getElementById('newNodeType').value = 'branch';
      renderTopicsTree();
      fillParentSelect();
      loadContentFileList();

      if(nodeType === "content" && newObj.dataFile){
        let sel = document.getElementById('contentNodesSelect');
        sel.value = newObj.dataFile;
        await loadContentFile();
      }
    }

    function generateFileNameForContent(path, newTitle){
      if(path === 'root'){
        let fn = newTitle.replace(/\s+/g, '_').replace(/[^\w_\-]/g, '').toLowerCase();
        return fn + ".json";
      } else {
        let realPath = JSON.parse(path);
        let chainTitles = getTitlesChain(realPath);
        let parentChain = chainTitles.map(t => t.replace(/\s+/g, '_').replace(/[^\w_\-]/g, '').toLowerCase()).join('_');
        let childPart = newTitle.replace(/\s+/g, '_').replace(/[^\w_\-]/g, '').toLowerCase();
        let finalName = "";
        if(parentChain){
          finalName = parentChain + "_" + childPart + ".json";
        } else {
          finalName = childPart + ".json";
        }
        return finalName;
      }
    }
    function generateTitleFieldForContent(path, newTitle){
      if(path === 'root'){
        return newTitle;
      } else {
        let realPath = JSON.parse(path);
        let chainTitles = getTitlesChain(realPath);
        if(chainTitles.length > 0){
          return chainTitles.join(" - ") + " - " + newTitle;
        } else {
          return newTitle;
        }
      }
    }
    function fillParentSelect(){
      let sel = document.getElementById('parentSelect');
      sel.innerHTML = '';
      let optRoot = document.createElement('option');
      optRoot.value = 'root';
      optRoot.textContent = 'Root';
      sel.appendChild(optRoot);

      if(!expTopics || !expTopics.topics) return;
      expTopics.topics.forEach((topic, i) => {
        addNodePathOption(sel, topic, JSON.stringify(['topics', i]), '');
      });
    }
    function addNodePathOption(sel, node, path, prefix){
      let opt = document.createElement('option');
      opt.value = path;
      opt.textContent = prefix + node.title;
      sel.appendChild(opt);
      if(node.subtopics && Array.isArray(node.subtopics)){
        node.subtopics.forEach((sub, i) => {
          let newPath = JSON.stringify([...JSON.parse(path), 'subtopics', i]);
          addNodePathOption(sel, sub, newPath, prefix + node.title + " > ");
        });
      }
    }

    /****
     * Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰
     ****/
    let currentContentFile = null;
    let currentContentSha = null;
    let originalContentHtml = '';

    function collectContentNodes(nodes, prefix){
      let result = [];
      for(let i=0; i<nodes.length; i++){
        let n = nodes[i];
        let currentPrefix = prefix ? (prefix + " > " + n.title) : n.title;
        if(n.dataFile){
          result.push({
            file: n.dataFile,
            fullPath: currentPrefix
          });
        }
        if(n.subtopics && n.subtopics.length>0){
          result = result.concat(collectContentNodes(n.subtopics, currentPrefix));
        }
      }
      return result;
    }
    function loadContentFileList(){
      let sel = document.getElementById('contentNodesSelect');
      sel.innerHTML = '<option value="">-- Select Content Node --</option>';
      if(!expTopics || !expTopics.topics) return;
      let all = collectContentNodes(expTopics.topics, "");
      all.forEach(obj => {
        let opt = document.createElement('option');
        opt.value = obj.file;
        opt.textContent = obj.fullPath;
        sel.appendChild(opt);
      });
    }

    async function loadContentFile(){
      let sel = document.getElementById('contentNodesSelect');
      if(!sel.value){
        alert("Please select a content node.");
        return;
      }
      currentContentFile = sel.value;
      try {
        let r = await fetch(`/api/get-content-file?filePath=${encodeURIComponent(currentContentFile)}`);
        let j = await r.json();
        if(!j.success){
          alert("Failed to load content: " + (j.error || ''));
          return;
        }
        currentContentSha = j.sha;
        let contentObj = j.content;
        if(!contentObj.content) contentObj.content = "";

        // Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„: Ù†Ø¹ÙƒØ³ Ø§Ù„ØªØ¶Ù…ÙŠÙ†/Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø§Ø±ÙƒØ¯Ø§ÙˆÙ†
        let turndownService = new TurndownService();

        // Ù‚Ø§Ø¹Ø¯Ø© ØªØ­ÙˆÙŠÙ„ Ø®Ø§ØµØ©:
        turndownService.addRule('customTriggers', {
          filter: function (node) {
            // Ø£ÙŠ button.trigger-button Ø£Ùˆ Ø£ÙŠ ØªØ¶Ù…ÙŠÙ† Ù…Ø¨Ø§Ø´Ø± (video, iframe, img, a, span)
            if(node.nodeName === 'BUTTON' && node.classList.contains('trigger-button')){
              return true;
            }
            if(['VIDEO','IMG','IFRAME','A','SPAN'].includes(node.nodeName)){
              return true;
            }
            return false;
          },
          replacement: function (content, node) {
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø²Ø± (button.trigger-button):
            if(node.nodeName === 'BUTTON' && node.classList.contains('trigger-button')){
              let cls = node.classList; // Ù…Ø«Ù„Ø§Ù‹ video-trigger, image-trigger, multi-trigger
              // Ù„Ùˆ multi-trigger => bum
              if(cls.contains('multi-trigger')){
                // Ù†Ø¬Ù…Ø¹ Ø§Ù„Ù€ data-attrs
                let items = [];
                if(node.hasAttribute('data-qids')){
                  let q = node.getAttribute('data-qids').replace(/,/g, ' ');
                  items.push(`q: ${q}`);
                }
                if(node.hasAttribute('data-vid-src')){
                  let vLink = node.getAttribute('data-vid-src');
                  // Ù„Ùˆ ÙÙŠÙ‡ youtu => buyv
                  // Ù„ÙƒÙ†Ù‡ multi => Ù†Ø¶Ø¹ "v: ..." ÙÙ‚Ø·
                  items.push(`v: ${vLink}`);
                }
                if(node.hasAttribute('data-img-src')){
                  items.push(`p: ${node.getAttribute('data-img-src')}`);
                }
                if(node.hasAttribute('data-link-href')){
                  items.push(`l: ${node.getAttribute('data-link-href')}`);
                }
                if(node.hasAttribute('data-text-content')){
                  items.push(`t: ${node.getAttribute('data-text-content')}`);
                }
                if(node.hasAttribute('data-iframe-src')){
                  items.push(`iframe: ${node.getAttribute('data-iframe-src')}`);
                }
                let joined = items.join(' / ');
                return `( bum: ${joined} )`;
              }
              // ÙˆØ¥Ù„Ø§ Ø²Ø± Ù…ÙØ±Ø¯
              if(cls.contains('video-trigger')){
                let link = node.getAttribute('data-vid-src')||'';
                // Ù‡Ù„ Ù‡Ùˆ youtubeØŸ Ù„Ùˆ Ø£Ø±Ø¯Øª ØªÙ…ÙŠÙŠØ²Ù‡ Ø¨Ù€ buyv
                if(link.includes('youtu')) {
                  return `( buyv: ${link} )`;
                } else {
                  return `( buv: ${link} )`;
                }
              }
              if(cls.contains('image-trigger')){
                let link = node.getAttribute('data-img-src')||'';
                return `( bup: ${link} )`;
              }
              if(cls.contains('question-trigger')){
                let q = node.getAttribute('data-qids')||'';
                q = q.replace(/,/g,' ');
                return `( buq: ${q} )`;
              }
              if(cls.contains('link-trigger')){
                let l = node.getAttribute('data-link-href')||'';
                return `( bul: ${l} )`;
              }
              if(cls.contains('text-trigger')){
                let t = node.getAttribute('data-text-content')||'';
                return `( but: ${t} )`;
              }
              if(cls.contains('iframe-trigger')){
                let f = node.getAttribute('data-iframe-src')||'';
                return `( buiframe: ${f} )`; // Ø£Ùˆ Ø£ÙŠ ØµÙŠØºØ© ØªØ±Ø§Ù‡Ø§
              }
            }

            // Ø£Ù…Ø§ Ù„Ùˆ ÙƒØ§Ù† ØªØ¶Ù…ÙŠÙ† Ù…Ø¨Ø§Ø´Ø±
            if(node.nodeName === 'VIDEO'){
              let src = node.getAttribute('src')||'';
              return `( v: ${src} )`;
            }
            if(node.nodeName === 'IFRAME'){
              // Ù†ÙØªØ±Ø¶ Ø£Ù†Ù‡ ÙŠÙˆØªÙŠÙˆØ¨ => yv
              let src = node.getAttribute('src')||'';
              return `( yv: ${src} )`;
            }
            if(node.nodeName === 'IMG'){
              let src = node.getAttribute('src')||'';
              return `( p: ${src} )`;
            }
            if(node.nodeName === 'A'){
              let href = node.getAttribute('href')||'';
              return `( l: ${href} )`;
            }
            if(node.nodeName === 'SPAN'){
              // Ù‚Ø¯ ÙŠÙƒÙˆÙ† question-trigger Ø£Ùˆ link-trigger... Ø¥Ù† ÙƒØ§Ù† ØªØ¶Ù…ÙŠÙ† Ù…Ø¨Ø§Ø´Ø±
              // Ù„ÙƒÙ† Ù„Ùˆ Ø²Ø± => button
              if(node.classList.contains('question-trigger')){
                let q = node.getAttribute('data-qids')||'';
                q = q.replace(/,/g, ' ');
                return `( q: ${q} )`;
              }
              if(node.classList.contains('link-trigger')){
                let l = node.getAttribute('data-link-href')||'';
                return `( l: ${l} )`;
              }
              if(node.classList.contains('video-trigger')){
                // Ù‚Ø¯ ÙŠÙƒÙˆÙ† ÙŠÙˆØªÙŠÙˆØ¨
                let link = node.getAttribute('data-vid-src')||'';
                if(link.includes('youtu')) {
                  return `( yv: ${link} )`;
                } else {
                  return `( v: ${link} )`;
                }
              }
              if(node.classList.contains('image-trigger')){
                let link = node.getAttribute('data-img-src')||'';
                return `( p: ${link} )`;
              }
              if(node.classList.contains('text-trigger')){
                let txt = node.getAttribute('data-text-content')||'';
                return `( t: ${txt} )`;
              }
              if(node.classList.contains('iframe-trigger')){
                let ifr = node.getAttribute('data-iframe-src')||'';
                return `( iframe: ${ifr} )`;
              }
            }

            return '';
          }
        });

        let md = turndownService.turndown(contentObj.content);
        document.getElementById('markdown-input').value = md;
        document.getElementById('markdown-result').innerHTML = contentObj.content;
        document.getElementById('contentLoadMsg').innerHTML = `<div class="alert alert-success">Content loaded successfully!</div>`;
        await alert("ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¨Ù†Ø¬Ø§Ø­!");
        originalContentHtml = contentObj.content;
      } catch(e){
        console.error(e);
        alert("Error loading content file");
      }
    }

    async function saveContentChanges(){
      if(!currentContentFile){
        alert("No content file selected.");
        return;
      }
      let confirmSave = await confirm("Are you sure you want to save current content?");
      if(!confirmSave) return;
      let finalHtml = document.getElementById('markdown-result').innerHTML;
      let payload = {
        filePath: currentContentFile,
        sha: currentContentSha,
        newContent: finalHtml
      };
      try {
        let r = await fetch('/api/save-content-file', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        let j = await r.json();
        if(j.success){
          alert("Content saved!");
          originalContentHtml = finalHtml;
          currentContentSha = j.newSha;
        } else {
          alert("Save failed: " + (j.error || ''));
        }
      } catch(e){
        console.error(e);
        alert("Error saving content file.");
      }
    }

    /****
     * Ù…Ø­Ø±Ø± Ø§Ù„Ù…Ø§Ø±ÙƒØ¯Ø§ÙˆÙ†
     ****/
    let currentDirection = 'ltr';
    function detectTextDirection(text) {
      let arabicCount = 0, totalCount = 0;
      for (let char of text) {
        if (!char.match(/\s/)) {
          totalCount++;
          if (char.match(/[\u0600-\u06FF]/)) arabicCount++;
        }
      }
      if (totalCount === 0) return 'rtl';
      return (arabicCount / totalCount > 0.3) ? 'rtl' : 'ltr';
    }

    /**
     * parseCustomTriggers:
     * - ØªØ¶Ù…ÙŠÙ† Ù…Ø¨Ø§Ø´Ø±: ( v: ), ( yv: ), ( p: ), ( q: ), ( l: ), ( t: ), ( iframe: )...
     * - Ø²Ø±: ( buv: ), ( buyv: ), ( bup: ), ( buq: ), ( bul: ), ( but: ), ( bum: )...
     */
    function parseCustomTriggers(mdText) {
      let result = mdText;

      // 1) Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø© bum:
      // Ø´ÙƒÙ„: ( bum: v: ... / p: ... / q: ... ) => <button class="trigger-button multi-trigger" data-vid-src="..." data-img-src="..." data-qids="..."></button>
      // Ù†Ø³ØªØ¹Ù…Ù„ Regex Ø¨Ø³ÙŠØ·: \( bum:\s*([^)]+?)\)
      // Ø«Ù… Ù†ÙØµÙ„ Ø¹Ù„Ù‰ '/'
      const bumRegex = /\(\s*bum:\s*([^)]*?)\)/g;
      result = result.replace(bumRegex, (full, inside) => {
        // inside Ù…Ø«Ù„Ø§Ù‹ "v: link / q: id / p: link"
        let parts = inside.split('/');
        let dataAttrs = [];
        parts.forEach(part => {
          let trimmed = part.trim();
          let [k, ...rest] = trimmed.split(':');
          if(!k || !rest.length) return;
          k = k.trim(); 
          let val = rest.join(':').trim();
          if(!val) return;
          if(k==='v'){
            dataAttrs.push(`data-vid-src="${val}"`);
          } else if(k==='q'){
            let arr = val.split(/\s+/).filter(Boolean).join(',');
            dataAttrs.push(`data-qids="${arr}"`);
          } else if(k==='p'){
            dataAttrs.push(`data-img-src="${val}"`);
          } else if(k==='l'){
            dataAttrs.push(`data-link-href="${val}"`);
          } else if(k==='t'){
            dataAttrs.push(`data-text-content="${val}"`);
          } else if(k==='iframe'){
            dataAttrs.push(`data-iframe-src="${val}"`);
          } else if(k==='yv'){
            // Ù„Ùˆ Ø£Ø±Ø§Ø¯ Ø§Ù„ÙŠÙˆØªÙŠÙˆØ¨ ÙÙŠ Ù…ØªØ¹Ø¯Ø¯
            dataAttrs.push(`data-vid-src="${val}"`);
          }
        });
        let dataStr = dataAttrs.join(' ');
        return `<button class="trigger-button multi-trigger" ${dataStr}></button>`;
      });

      // 2) Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…ÙØ±Ø¯Ø©: ( buv: ) ( buyv: ) ( bup: ) ( buq: ) ( bul: ) ( but: ) ... Ø§Ù„Ø®
      // Regex: \(\s*(buv|buyv|bup|buq|bul|but|buiframe)\s*:\s*([^)]+)\)
      const singleBtnRegex = /\(\s*(buv|buyv|bup|buq|bul|but|buiframe)\s*:\s*([^)]*?)\)/g;
      result = result.replace(singleBtnRegex, (full, key, val) => {
        let trimmedVal = val.trim();
        switch(key){
          case 'buv':
            return `<button class="trigger-button video-trigger" data-vid-src="${trimmedVal}"></button>`;
          case 'buyv':
            // Ø²Ø± ÙŠÙˆØªÙŠÙˆØ¨
            return `<button class="trigger-button video-trigger" data-vid-src="${trimmedVal}"></button>`;
          case 'bup':
            return `<button class="trigger-button image-trigger" data-img-src="${trimmedVal}"></button>`;
          case 'buq':
            let arr = trimmedVal.split(/\s+/).filter(Boolean).join(',');
            return `<button class="trigger-button question-trigger" data-qids="${arr}"></button>`;
          case 'bul':
            return `<button class="trigger-button link-trigger" data-link-href="${trimmedVal}"></button>`;
          case 'but':
            return `<button class="trigger-button text-trigger" data-text-content="${trimmedVal}"></button>`;
          case 'buiframe':
            return `<button class="trigger-button iframe-trigger" data-iframe-src="${trimmedVal}"></button>`;
        }
        return full;
      });

      // 3) Ø§Ù„ØªØ¶Ù…ÙŠÙ† Ø§Ù„Ù…Ø¨Ø§Ø´Ø±: ( v: ), ( yv: ), ( p: ), ( q: ), ( l: ), ( t: ), ( iframe: ) ...
      // Ù…Ø«Ù„: ( v: link ) => <video src="..." controls></video>
      // ( yv: link ) => <iframe src="..." ... ></iframe> (ÙŠÙˆØªÙŠÙˆØ¨)
      const directRegex = /\(\s*(v|yv|p|q|l|t|iframe)\s*:\s*([^)]*?)\)/g;
      result = result.replace(directRegex, (full, key, val) => {
        let trimmedVal = val.trim();
        if(key==='v'){
          return `<video src="${trimmedVal}" controls></video>`;
        } else if(key==='yv'){
          // ØªØ¶Ù…ÙŠÙ† ÙŠÙˆØªÙŠÙˆØ¨
          return `<iframe src="${trimmedVal}" width="560" height="315" frameborder="0" allowfullscreen></iframe>`;
        } else if(key==='p'){
          return `<img src="${trimmedVal}" alt=""/>`;
        } else if(key==='q'){
          let arr = trimmedVal.split(/\s+/).filter(Boolean).join(',');
          return `<span class="question-trigger" data-qids="${arr}"></span>`;
        } else if(key==='l'){
          return `<a href="${trimmedVal}" target="_blank"></a>`;
        } else if(key==='t'){
          return `<span class="text-trigger" data-text-content="${trimmedVal}"></span>`;
        } else if(key==='iframe'){
          return `<span class="iframe-trigger" data-iframe-src="${trimmedVal}"></span>`;
        }
        return full;
      });

      return result;
    }

    function convertMarkdown() {
      const markdownText = document.getElementById('markdown-input').value;
      let replacedText = parseCustomTriggers(markdownText);
      const htmlContent = marked.parse(replacedText);
      document.getElementById('markdown-result').innerHTML = htmlContent;
      currentDirection = detectTextDirection(markdownText);
      document.getElementById('markdown-result').style.direction = currentDirection;
    }

    function printResult() {
      const resultDivContent = document.getElementById('markdown-result').innerHTML;
      const printWindow = window.open('about:blank', '_blank', 'width=800,height=600');
      const langAttr = (currentDirection === 'rtl') ? 'ar' : 'en';
      const styleContent = `
        @media print {
          body { -webkit-print-color-adjust: exact; }
        }
        body {
          font-family: 'Roboto', sans-serif;
          background: linear-gradient(135deg, #faf3e7, #eef7f6);
          margin: 0;
          padding: 0;
          color: #2c3e50;
        }
        #printResult { padding: 20px; }
      `;
      printWindow.document.write(
        `<html lang="${langAttr}" dir="${currentDirection}">
          <head>
            <meta charset="UTF-8" />
            <title>Print Result</title>
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css" rel="stylesheet" crossorigin="anonymous">
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
            <style>${styleContent}</style>
          </head>
          <body>
            <div id="printResult" style="direction: ${currentDirection};">
              ${resultDivContent}
            </div>
            <script>
              window.onload = function() { window.print(); }
            <\/script>
          </body>
        </html>`
      );
      printWindow.document.close();
    }

    /****
     * Ø²Ø± Ø¹Ø§Ø¦Ù… Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù€ triggers (Ù…Ø®ÙÙ‰)
     ****/
    let selectionInProgress = false;
    function handleToolsModalClick(){
      if(selectionInProgress){
        document.getElementById('selectionDonePrompt').style.display = 'block';
      } else {
        openToolsModal();
      }
    }
    function openToolsModal(){
      document.getElementById('toolsOverlay').style.display = 'flex';
    }
    function closeToolsModal(){
      document.getElementById('toolsOverlay').style.display = 'none';
    }

    function openManageTriggersModal(){
      let overlay = document.getElementById('manageTriggersOverlay');
      let container = document.getElementById('insertedTriggersList');
      container.innerHTML = "Listing triggers is not implemented yet...";
      overlay.style.display = 'flex';
    }
    function closeManageTriggersModal(){
      document.getElementById('manageTriggersOverlay').style.display = 'none';
    }

    let userSelectionRange = null;
    let currentTriggerType = null;
    function openTriggerForm(type){
      closeToolsModal();
      currentTriggerType = type;
      let overlay = document.getElementById('triggerFormOverlay');
      let titleEl = document.getElementById('triggerFormTitle');
      let contentEl = document.getElementById('triggerFormContent');
      overlay.style.display = 'flex';
      contentEl.innerHTML = "";

      let formHtml = "";
      switch(type){
        case 'link':
          titleEl.textContent = "Add Link Trigger";
          formHtml = `
            <div class="mb-2">
              <label>Description (optional):</label>
              <input type="text" id="triggerDesc" class="form-control" placeholder="desc...">
            </div>
            <div class="mb-2">
              <button class="btn btn-sm btn-info" onclick="startSelectionMode()">Select Text Range</button>
            </div>
            <div class="mb-2">
              <label>Position:</label>
              <select id="triggerPosition" class="form-select">
                <option value="before">Before</option>
                <option value="after">After</option>
                <option value="inside">Inside</option>
              </select>
            </div>
            <div class="mb-2">
              <label>Link URL:</label>
              <input type="text" id="triggerLinkUrl" class="form-control" placeholder="https://...">
            </div>
            <button class="btn btn-primary w-100" onclick="applyTriggerInsertion()">Insert</button>
          `;
          break;
        case 'video':
          titleEl.textContent = "Add Video Trigger";
          formHtml = `
            <div class="mb-2">
              <label>Description (optional):</label>
              <input type="text" id="triggerDesc" class="form-control" placeholder="desc...">
            </div>
            <div class="mb-2">
              <button class="btn btn-sm btn-info" onclick="startSelectionMode()">Select Text Range</button>
            </div>
            <div class="mb-2">
              <label>Position:</label>
              <select id="triggerPosition" class="form-select">
                <option value="before">Before</option>
                <option value="after">After</option>
                <option value="inside">Inside</option>
              </select>
            </div>
            <div class="mb-2">
              <label>Video URL:</label>
              <input type="text" id="triggerLinkUrl" class="form-control" placeholder="https://...">
            </div>
            <button class="btn btn-primary w-100" onclick="applyTriggerInsertion()">Insert</button>
          `;
          break;
        case 'iframe':
          titleEl.textContent = "Add iFrame Trigger";
          formHtml = `
            <div class="mb-2">
              <label>Description (optional):</label>
              <input type="text" id="triggerDesc" class="form-control" placeholder="desc...">
            </div>
            <div class="mb-2">
              <button class="btn btn-sm btn-info" onclick="startSelectionMode()">Select Text Range</button>
            </div>
            <div class="mb-2">
              <label>iFrame URL:</label>
              <input type="text" id="triggerLinkUrl" class="form-control" placeholder="https://youtube.com/embed/...">
            </div>
            <button class="btn btn-primary w-100" onclick="applyTriggerInsertion()">Insert</button>
          `;
          break;
        case 'qids':
          titleEl.textContent = "Add Q-ID(s)";
          formHtml = `
            <div class="mb-2">
              <label>Description (optional):</label>
              <input type="text" id="triggerDesc" class="form-control" placeholder="desc...">
            </div>
            <div class="mb-2">
              <button class="btn btn-sm btn-info" onclick="startSelectionMode()">Select Text Range</button>
            </div>
            <div class="mb-2">
              <label>Q-IDs (space separated):</label>
              <input type="text" id="triggerLinkUrl" class="form-control" placeholder="q1 q2 q3">
            </div>
            <button class="btn btn-primary w-100" onclick="applyTriggerInsertion()">Insert</button>
          `;
          break;
        case 'text':
          titleEl.textContent = "Add Custom Text";
          formHtml = `
            <div class="mb-2">
              <label>Description (optional):</label>
              <input type="text" id="triggerDesc" class="form-control" placeholder="desc...">
            </div>
            <div class="mb-2">
              <button class="btn btn-sm btn-info" onclick="startSelectionMode()">Select Text Range</button>
            </div>
            <div class="mb-2">
              <label>Custom text:</label>
              <textarea id="triggerLinkUrl" class="form-control"></textarea>
            </div>
            <button class="btn btn-primary w-100" onclick="applyTriggerInsertion()">Insert</button>
          `;
          break;
      }
      contentEl.innerHTML = formHtml;
    }

    function closeTriggerForm(){
      document.getElementById('triggerFormOverlay').style.display = 'none';
    }

    function startSelectionMode(){
      document.getElementById('triggerFormOverlay').style.display = 'none';
      selectionInProgress = true;
      document.getElementById('selectionDonePrompt').style.display = 'block';
      alert("Select text in the markdown input area.");
    }

    function selectionDoneYes(){
      document.getElementById('selectionDonePrompt').style.display = 'none';
      let ta = document.getElementById('markdown-input');
      userSelectionRange = {start: ta.selectionStart, end: ta.selectionEnd};
      selectionInProgress = false;
      document.getElementById('triggerFormOverlay').style.display = 'flex';
    }
    function selectionDoneNo(){
      document.getElementById('selectionDonePrompt').style.display = 'none';
      selectionInProgress = true;
    }

    function applyTriggerInsertion(){
      if(!userSelectionRange){
        alert("No selection range set!");
        return;
      }
      let desc = document.getElementById('triggerDesc') ? document.getElementById('triggerDesc').value : "";
      let pos = document.getElementById('triggerPosition') ? document.getElementById('triggerPosition').value : "before";
      let valEl = document.getElementById('triggerLinkUrl');
      let val = valEl ? valEl.value || "" : "";

      let ta = document.getElementById('markdown-input');
      let textVal = ta.value;
      let beforeText = textVal.slice(0, userSelectionRange.start);
      let selectedText = textVal.slice(userSelectionRange.start, userSelectionRange.end);
      let afterText = textVal.slice(userSelectionRange.end);

      // Ù…Ø¬Ø±Ø¯ Ø¥Ø¯Ø±Ø§Ø¬ Ø¨Ø³ÙŠØ·
      let finalInsert = `[${desc||"Link"}](${val})`; // ÙƒÙ…Ø«Ø§Ù„

      let replaced = "";
      if(pos==="before"){
        replaced = beforeText + finalInsert + selectedText + afterText;
      } else if(pos==="after"){
        replaced = beforeText + selectedText + finalInsert + afterText;
      } else {
        let mid = selectedText + finalInsert;
        replaced = beforeText + mid + afterText;
      }

      ta.value = replaced;
      convertMarkdown();
      userSelectionRange = null;
      closeTriggerForm();
    }

    /****
     * Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±
     ****/
    function openImageUploader(){
      closeToolsModal();
      document.getElementById('imageUploadOverlay').style.display = 'flex';
      document.getElementById('localImageFile').value = "";
      document.getElementById('uploadProgress').style.display = 'none';
      document.getElementById('uploadProgressBar').style.width = '0%';
      document.getElementById('uploadProgressBar').textContent = '0%';
      document.getElementById('imageLinkInput').value = "";
      document.getElementById('uploadedImagesList').innerHTML = "";
    }
    function closeImageUploader(){
      document.getElementById('imageUploadOverlay').style.display = 'none';
    }
    function insertImageLink(){
      let linkVal = document.getElementById('imageLinkInput').value.trim();
      if(!linkVal) return;
      let mdInput = document.getElementById('markdown-input');
      mdInput.value += `\n![Image](${linkVal})\n`;
      convertMarkdown();
      alert("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø©!");
    }
    async function uploadLocalImages(){
      let files = document.getElementById('localImageFile').files;
      if(!files || files.length===0) return;
      let ul = document.getElementById('uploadedImagesList');
      document.getElementById('uploadProgress').style.display = 'block';
      for(let i=0; i<files.length; i++){
        let f = files[i];
        let reader = new FileReader();
        reader.onload = async function(e){
          let base64Data = e.target.result.split(',')[1];
          let body = {
            name: f.name,
            base64: base64Data
          };
          document.getElementById('uploadProgressBar').style.width = '50%';
          document.getElementById('uploadProgressBar').textContent = 'Uploading... (50%)';
          let r = await fetch('/api/upload-image', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(body)
          });
          let j = await r.json();
          if(j.success){
            document.getElementById('uploadProgressBar').style.width = '100%';
            document.getElementById('uploadProgressBar').textContent = '100%';
            let li = document.createElement('li');
            li.innerHTML = `Uploaded: <a href="${j.url}" target="_blank">${j.url}</a>
              <button class="btn btn-sm btn-danger ms-2" onclick="deleteImage('${j.filePath}', this)">Delete</button>
              <button class="btn btn-sm btn-info ms-2" onclick="insertThisImageLink('${j.url}')">Insert</button>`;
            ul.appendChild(li);
          } else {
            let li = document.createElement('li');
            li.innerHTML = `Error uploading ${f.name}: ${j.error || 'unknown error'}`;
            ul.appendChild(li);
          }
        };
        reader.readAsDataURL(f);
      }
    }
    function insertThisImageLink(url){
      let mdInput = document.getElementById('markdown-input');
      mdInput.value += `\n![Image](${url})\n`;
      convertMarkdown();
      alert("ØªÙ… Ø¥Ø¯Ø±Ø§Ø¬ Ø§Ù„ØµÙˆØ±Ø© ÙÙŠ Ø§Ù„Ù…Ø§Ø±ÙƒØ¯Ø§ÙˆÙ†!");
    }
    async function deleteImage(filePath, btnRef){
      let conf = await confirm("Are you sure you want to delete this image from GitHub?");
      if(!conf) return;
      let r = await fetch(`/api/delete-image?filePath=${encodeURIComponent(filePath)}`, {
        method: 'DELETE'
      });
      let j = await r.json();
      if(j.success){
        alert("Image deleted!");
        btnRef.parentElement.remove();
      } else {
        alert("Failed to delete image: " + (j.error||''));
      }
    }
  </script>
</body>
</html>
