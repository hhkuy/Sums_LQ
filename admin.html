<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
  <title>Admin Panel - Manage Topics & Content</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(135deg, #f5f7fa, #c3cfe2);
      font-family: 'Roboto', sans-serif;
      padding: 20px 0;
    }
    .container-custom {
      max-width: 1200px;
      background-color: #fff;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      margin: auto;
    }
    h1 {
      text-align: center;
      margin-bottom: 30px;
      color: #343a40;
      font-weight: 600;
    }
    .card-section {
      margin-bottom: 30px;
      border-radius: 15px;
      overflow: hidden;
    }
    .card-section .card-header {
      background-color: #343a40;
      color: #fff;
      font-size: 1.25em;
    }
    .btn-custom {
      width: 100%;
      padding: 12px;
      font-size: 1.1em;
      border-radius: 50px;
      transition: all 0.3s ease;
    }
    .btn-custom:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
    }
    .topic-node {
      border: 1px solid #dee2e6;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 15px;
      background-color: #f8f9fa;
    }
    .topic-node .node-title {
      font-weight: bold;
      color: #495057;
    }
    .sub-node {
      margin-left: 20px;
      margin-top: 10px;
      border-left: 2px dashed #ccc;
      padding-left: 10px;
    }
    .content-editor {
      min-height: 200px;
      border: 1px solid #ccc;
      padding: 10px;
      overflow-y: auto;
    }
    /* Floating Buttons */
    #floatScrollBtn {
      position: fixed;
      width: 50px;
      height: 50px;
      background: #4a90e2;
      color: #fff;
      border: none;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      cursor: pointer;
      z-index: 999;
      top: 50%;
      right: 30px;
      transform: translateY(-50%);
    }
    #floatScrollBtn:hover {
      opacity: 0.8;
    }
    /* Modals */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    .modal-box {
      background: #fff;
      border-radius: 8px;
      padding: 20px;
      max-width: 500px;
      width: 90%;
      text-align: center;
    }
    .modal-box h3 {
      margin-bottom: 20px;
      font-size: 1.1rem;
      color: #333;
    }
    .modal-buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="container-custom">
    <h1><i class="bi bi-journal-text"></i> Admin Panel - Manage Topics & Content</h1>

    <!-- Topics Section -->
    <div class="card card-section">
      <div class="card-header">Manage Topics (exp_topics.json)</div>
      <div class="card-body">
        <div class="mb-3">
          <button class="btn btn-primary btn-custom" onclick="loadExpTopics()">Load exp_topics.json</button>
        </div>

        <div id="topicsTree"></div>

        <hr>

        <!-- Add New Node Form -->
        <div class="row g-2 align-items-center">
          <div class="col-md-4">
            <input type="text" id="newNodeTitle" class="form-control" placeholder="Title...">
          </div>
          <div class="col-md-4">
            <select id="newNodeType" class="form-select">
              <option value="branch">Branch</option>
              <option value="content">Content</option>
            </select>
          </div>
          <div class="col-md-4">
            <button class="btn btn-success btn-custom" onclick="addNode()">Add Node</button>
          </div>
        </div>

        <div class="row g-2 mt-3 align-items-center">
          <div class="col-md-12">
            <label>Select where to add:</label>
            <select id="parentSelect" class="form-select"></select>
          </div>
        </div>

        <hr>
        <div class="mt-3">
          <button class="btn btn-primary btn-custom" onclick="saveExpTopics()">Save All Changes</button>
        </div>
      </div>
    </div>
    <!-- End Topics Section -->

    <!-- Manage Content Section -->
    <div class="card card-section">
      <div class="card-header">Manage Content (files with dataFile)</div>
      <div class="card-body">
        <div class="mb-3">
          <select id="contentNodesSelect" class="form-select">
            <option value="">-- Select Content Node --</option>
          </select>
        </div>
        <div class="mb-3">
          <button class="btn btn-primary btn-custom" onclick="loadContentFile()">Load Content File</button>
        </div>
        <div id="contentLoadMsg"></div>

        <hr>

        <!-- محرر النصوص -->
        <div class="mb-2">
          <label for="contentEditor" class="form-label">Content Editor</label>
          <div id="contentEditor" class="content-editor" contenteditable="true"></div>
        </div>

        <div class="row g-2 mt-2">
          <div class="col-md-6">
            <button class="btn btn-info btn-custom" onclick="previewContent()">Preview</button>
          </div>
          <div class="col-md-6">
            <button class="btn btn-success btn-custom" onclick="saveContentChanges()">Save Content</button>
          </div>
        </div>

        <div id="previewArea" class="mt-3" style="border:1px solid #ddd; padding:10px; display:none;">
          <h5>Preview:</h5>
          <div id="previewContent"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Floating Scroll Button -->
  <button id="floatScrollBtn" onclick="toggleScroll()">↓</button>

  <!-- Modal Overlays for Alerts/Confirms/Prompts -->
  <div class="modal-overlay" id="alertOverlay">
    <div class="modal-box">
      <h3 id="alertMsg"></h3>
      <div class="modal-buttons">
        <button class="btn btn-primary" id="alertOkBtn">OK</button>
      </div>
    </div>
  </div>
  <div class="modal-overlay" id="confirmOverlay">
    <div class="modal-box">
      <h3 id="confirmMsg"></h3>
      <div class="modal-buttons">
        <button class="btn btn-primary" id="confirmYesBtn">Yes</button>
        <button class="btn btn-danger" id="confirmNoBtn">No</button>
      </div>
    </div>
  </div>
  <div class="modal-overlay" id="promptOverlay">
    <div class="modal-box">
      <h3 id="promptMsg"></h3>
      <input type="text" id="promptInput" class="form-control mb-3">
      <div class="modal-buttons">
        <button class="btn btn-primary" id="promptOkBtn">OK</button>
        <button class="btn btn-secondary" id="promptCancelBtn">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

  <script>
    /* ==================== Modal system (Alert, Confirm, Prompt) ==================== */
    let alertOverlay = document.getElementById('alertOverlay');
    let alertMsg = document.getElementById('alertMsg');
    let alertOkBtn = document.getElementById('alertOkBtn');

    let confirmOverlay = document.getElementById('confirmOverlay');
    let confirmMsg = document.getElementById('confirmMsg');
    let confirmYesBtn = document.getElementById('confirmYesBtn');
    let confirmNoBtn = document.getElementById('confirmNoBtn');

    let promptOverlay = document.getElementById('promptOverlay');
    let promptMsg = document.getElementById('promptMsg');
    let promptInput = document.getElementById('promptInput');
    let promptOkBtn = document.getElementById('promptOkBtn');
    let promptCancelBtn = document.getElementById('promptCancelBtn');

    function customAlert(message) {
      return new Promise(resolve => {
        alertMsg.textContent = message;
        alertOverlay.style.display = 'flex';
        alertOkBtn.onclick = () => {
          alertOverlay.style.display = 'none';
          resolve();
        };
      });
    }
    function customConfirm(message) {
      return new Promise(resolve => {
        confirmMsg.textContent = message;
        confirmOverlay.style.display = 'flex';
        confirmYesBtn.onclick = () => {
          confirmOverlay.style.display = 'none';
          resolve(true);
        };
        confirmNoBtn.onclick = () => {
          confirmOverlay.style.display = 'none';
          resolve(false);
        };
      });
    }
    function customPrompt(message, defVal) {
      return new Promise(resolve => {
        promptMsg.textContent = message;
        promptInput.value = defVal || '';
        promptOverlay.style.display = 'flex';
        promptOkBtn.onclick = () => {
          let val = promptInput.value;
          promptOverlay.style.display = 'none';
          resolve(val);
        };
        promptCancelBtn.onclick = () => {
          promptOverlay.style.display = 'none';
          resolve(null);
        };
      });
    }
    window.alert = async function(msg) { await customAlert(msg); };
    window.confirm = async function(msg) { return customConfirm(msg); };
    window.prompt = async function(msg, defVal) { return customPrompt(msg, defVal); };

    /* ==================== Floating Scroll button ==================== */
    let scrollDown = true;
    function toggleScroll(){
      let btn = document.getElementById('floatScrollBtn');
      if(scrollDown){
        window.scrollTo({top: document.body.scrollHeight, behavior:'smooth'});
        btn.textContent = '↑';
        scrollDown = false;
      } else {
        window.scrollTo({top:0, behavior:'smooth'});
        btn.textContent = '↓';
        scrollDown = true;
      }
    }

    /* ==================== Global data for topics & content ==================== */
    let expTopics = null;  // Holds the loaded exp_topics.json object
    let topicsSha = null;  // SHA of exp_topics.json on GitHub

    let currentContentFile = null;
    let currentContentSha = null;
    let originalContentHtml = '';

    /* ==================== Helper: get full path to a node ==================== */
    // Return array of node titles from root to this node
    function getNodePathTitles(topics, path){
      // path could be e.g. ["topics", 0, "subtopics", 1]...
      let arr = [];
      let ref = topics;
      for(let i=0; i<path.length; i++){
        let key = path[i];
        if(typeof key === 'number') {
          // It's an index in array
          let node = ref[key];
          if(node && node.title) arr.push(node.title);
        }
        ref = ref[key];
      }
      return arr;
    }

    // Join array with underscores for file name, or with " - " for display
    function joinForFileName(titles){
      return titles.map(t => t.replace(/\s+/g, '_')).join('_');
    }
    function joinForDisplay(titles){
      return titles.join(' - ');
    }

    /* ==================== 1) Load exp_topics.json ==================== */
    async function loadExpTopics(){
      try {
        let r = await fetch('/api/get-exp-topics');
        let data = await r.json();
        if(!data.success) {
          alert("Failed to load exp_topics.json: " + (data.error||''));
          return;
        }
        expTopics = data.content;
        topicsSha = data.sha;
        renderTopicsTree();
        fillParentSelect();
        loadContentFileList(); // populate content list
      } catch(e){
        console.error(e);
        alert("Error loading exp_topics.json");
      }
    }

    /* ==================== 2) Save exp_topics.json ==================== */
    async function saveExpTopics(){
      if(!expTopics){
        alert("No data loaded yet.");
        return;
      }
      let conf = await confirm("Are you sure you want to save changes to exp_topics.json?");
      if(!conf) return;
      try {
        let body = {
          content: expTopics,
          sha: topicsSha
        };
        let r = await fetch('/api/save-exp-topics', {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify(body)
        });
        let j = await r.json();
        if(j.success){
          alert("Saved successfully!");
        } else {
          alert("Save failed: " + (j.error||''));
        }
      } catch(e){
        console.error(e);
        alert("Error saving topics");
      }
    }

    /* ==================== Render topics tree ==================== */
    function renderTopicsTree(){
      let container = document.getElementById('topicsTree');
      container.innerHTML = '';
      if(!expTopics || !expTopics.topics) return;

      expTopics.topics.forEach((topic, index) => {
        let nodeEl = createNodeElement(topic, ['topics', index]);
        container.appendChild(nodeEl);
      });
    }

    function createNodeElement(nodeObj, path){
      let div = document.createElement('div');
      div.className = 'topic-node';
      let label = document.createElement('div');
      label.className = 'node-title mb-2';
      let nodeTitle = nodeObj.title || "Untitled";
      label.textContent = nodeTitle;

      // Buttons
      let btnGroup = document.createElement('div');
      btnGroup.className = 'btn-group-sm';

      // Up
      let upBtn = document.createElement('button');
      upBtn.className = 'btn btn-secondary me-1';
      upBtn.textContent = '▲';
      upBtn.onclick = () => moveNodeUp(path);
      btnGroup.appendChild(upBtn);
      // Down
      let downBtn = document.createElement('button');
      downBtn.className = 'btn btn-secondary me-1';
      downBtn.textContent = '▼';
      downBtn.onclick = () => moveNodeDown(path);
      btnGroup.appendChild(downBtn);
      // Edit
      let editBtn = document.createElement('button');
      editBtn.className = 'btn btn-warning me-1';
      editBtn.textContent = 'Edit';
      editBtn.onclick = () => editNodeTitle(path);
      btnGroup.appendChild(editBtn);
      // Delete
      let delBtn = document.createElement('button');
      delBtn.className = 'btn btn-danger me-1';
      delBtn.textContent = 'Delete';
      delBtn.onclick = () => deleteNode(path);
      btnGroup.appendChild(delBtn);

      label.appendChild(btnGroup);
      div.appendChild(label);

      // Subtopics
      if(nodeObj.subtopics && Array.isArray(nodeObj.subtopics)){
        nodeObj.subtopics.forEach((subtopic, i) => {
          let subDiv = document.createElement('div');
          subDiv.className = 'sub-node';
          let subpath = [...path, 'subtopics', i];
          let element = createNodeElement(subtopic, subpath);
          subDiv.appendChild(element);
          div.appendChild(subDiv);
        });
      }
      return div;
    }

    function getParentArrayAndIndex(path){
      let parentArray = expTopics;
      for(let i=0; i<path.length-1; i++){
        parentArray = parentArray[path[i]];
      }
      let indexInArray = path[path.length-1];
      return { parentArray, indexInArray };
    }

    function moveNodeUp(path){
      let { parentArray, indexInArray } = getParentArrayAndIndex(path);
      if(indexInArray > 0){
        [ parentArray[indexInArray-1], parentArray[indexInArray] ] = [ parentArray[indexInArray], parentArray[indexInArray-1] ];
        renderTopicsTree();
        fillParentSelect();
        loadContentFileList();
      }
    }
    function moveNodeDown(path){
      let { parentArray, indexInArray } = getParentArrayAndIndex(path);
      if(indexInArray < parentArray.length-1){
        [ parentArray[indexInArray], parentArray[indexInArray+1] ] = [ parentArray[indexInArray+1], parentArray[indexInArray] ];
        renderTopicsTree();
        fillParentSelect();
        loadContentFileList();
      }
    }

    /* ==================== Rename node, also rename file if dataFile exists ==================== */
    async function editNodeTitle(path){
      let { parentArray, indexInArray } = getParentArrayAndIndex(path);
      let node = parentArray[indexInArray];
      let oldTitle = node.title;
      let newTitle = await prompt("Enter new title:", oldTitle);
      if(newTitle===null || !newTitle.trim()) return;
      newTitle = newTitle.trim();
      node.title = newTitle;

      // If node has dataFile, we must rename file on GitHub, and update dataFile in memory
      if(node.dataFile){
        let oldFilePath = node.dataFile; 
        // Generate new file name based on parent's path + newTitle
        let ancestors = getNodePathTitles(expTopics.topics, path); // updated last is newTitle
        let newFileName = joinForFileName(ancestors) + '.json';
        let newFilePath = 'exp_data/' + newFileName;

        let renameResp = await renameContentFileOnGitHub(oldFilePath, newFilePath, ancestors);
        if(renameResp.success){
          node.dataFile = newFilePath; // update in local structure
        } else {
          // revert
          node.title = oldTitle;
          alert("Could not rename file: " + (renameResp.error||''));
        }
      }

      renderTopicsTree();
      fillParentSelect();
      loadContentFileList();
    }

    /* renameContentFileOnGitHub: read old file, create new file with updated 'title' inside JSON, then delete old file. */
    async function renameContentFileOnGitHub(oldPath, newPath, ancestorsArr){
      try {
        // Get old file
        let getResp = await fetch('/api/get-content-file?filePath='+encodeURIComponent(oldPath));
        let getJ = await getResp.json();
        if(!getJ.success) return { success:false, error:getJ.error||'Cannot read old file' };
        let contentObj = getJ.content; // { title, content... } or some structure
        // update "title" => joinForDisplay(ancestorsArr)
        contentObj.title = joinForDisplay(ancestorsArr);

        // create new file
        let body = {
          fileName: newPath.replace('exp_data/',''),
          oldContentObj: contentObj,
          oldSha: getJ.sha,
          oldPath
        };
        // We'll do this in 2 steps: first create the new file with the same content. Then delete old file.
        let createRes = await fetch('/api/rename-file', {
          method: 'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(body)
        });
        let createJ = await createRes.json();
        if(!createJ.success) return { success:false, error:createJ.error };

        // done
        return { success:true };
      } catch(e){
        console.error("renameContentFileOnGitHub error", e);
        return { success:false, error:e.toString() };
      }
    }

    /* ==================== Delete node (and file if dataFile) ==================== */
    async function deleteNode(path){
      let { parentArray, indexInArray } = getParentArrayAndIndex(path);
      let node = parentArray[indexInArray];

      if(node.dataFile){
        let confirmDel = await confirm("This node has dataFile. Deleting will remove its file from GitHub. Proceed?");
        if(!confirmDel) return;
        let delResp = await fetch('/api/delete-file?filePath='+encodeURIComponent(node.dataFile), {
          method:'DELETE'
        });
        let delJ = await delResp.json();
        if(!delJ.success){
          alert("Could not delete file from GitHub: " + (delJ.error||''));
          return;
        }
      } else {
        let confirmDel = await confirm("Delete this branch (and all sub-branches)?");
        if(!confirmDel) return;
        // delete sub-nodes with dataFile
        await deleteNestedFiles(node);
      }

      parentArray.splice(indexInArray,1);
      renderTopicsTree();
      fillParentSelect();
      loadContentFileList();
    }
    async function deleteNestedFiles(node){
      if(node.subtopics && Array.isArray(node.subtopics)){
        for(let st of node.subtopics){
          if(st.dataFile){
            await fetch('/api/delete-file?filePath='+encodeURIComponent(st.dataFile), {method:'DELETE'});
          }
          if(st.subtopics) await deleteNestedFiles(st);
        }
      }
    }

    /* ==================== Add Node (branch or content) ==================== */
    async function addNode(){
      if(!expTopics){
        alert("Load exp_topics.json first!");
        return;
      }
      let nodeTitle = document.getElementById('newNodeTitle').value.trim();
      if(!nodeTitle){
        alert("Please enter a title.");
        return;
      }
      let nodeType = document.getElementById('newNodeType').value; // "branch" or "content"
      let parentVal = document.getElementById('parentSelect').value; // "root" or JSON string path

      let newObj = { title: nodeTitle };
      if(nodeType === 'branch'){
        newObj.subtopics = [];
      }

      if(parentVal === 'root'){
        // add to top-level
        expTopics.topics.push(newObj);
      } else {
        let path = JSON.parse(parentVal);
        let { parentArray, indexInArray } = getParentArrayAndIndex(path);
        let parentNode = parentArray[indexInArray];
        if(!parentNode.subtopics) parentNode.subtopics = [];
        parentNode.subtopics.push(newObj);
      }

      // If content => create a file in exp_data
      if(nodeType === 'content'){
        let path = (parentVal === 'root') ? [] : JSON.parse(parentVal);
        let fullPathTitles = getNodePathTitles(expTopics.topics, path).concat([nodeTitle]);
        let fileName = joinForFileName(fullPathTitles) + '.json'; // e.g. CNS_Anatomy.json
        let displayTitle = joinForDisplay(fullPathTitles);        // e.g. "CNS - Anatomy"

        let resp = await fetch('/api/add-file', {
          method: 'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ fileName, customTitle: displayTitle })
        });
        let j = await resp.json();
        if(j.success){
          newObj.dataFile = j.filePath; // e.g. exp_data/CNS_Anatomy.json
        } else {
          alert("Could not create file: " + (j.error||''));
        }
      }

      document.getElementById('newNodeTitle').value = '';
      document.getElementById('newNodeType').value = 'branch';
      renderTopicsTree();
      fillParentSelect();
      loadContentFileList(); // refresh content list
    }

    /* ==================== Fill parent <select> for adding new nodes ==================== */
    function fillParentSelect(){
      let sel = document.getElementById('parentSelect');
      sel.innerHTML = '';
      let optRoot = document.createElement('option');
      optRoot.value = 'root';
      optRoot.textContent = 'Root';
      sel.appendChild(optRoot);

      if(!expTopics || !expTopics.topics) return;
      expTopics.topics.forEach((topic, i) => {
        addNodePathOption(sel, topic, ['topics', i], '');
      });
    }
    function addNodePathOption(sel, node, path, prefix){
      let opt = document.createElement('option');
      opt.value = JSON.stringify(path);
      opt.textContent = prefix + node.title;
      sel.appendChild(opt);

      if(node.subtopics && Array.isArray(node.subtopics)){
        node.subtopics.forEach((sub, i) => {
          addNodePathOption(sel, sub, [...path,'subtopics', i], prefix + node.title + " > ");
        });
      }
    }

    /* ==================== Fill contentNodesSelect with all content nodes ==================== */
    function loadContentFileList(){
      let sel = document.getElementById('contentNodesSelect');
      sel.innerHTML = '<option value="">-- Select Content Node --</option>';

      if(!expTopics || !expTopics.topics) return;
      let allContentNodes = getAllContentNodes(expTopics.topics, []);
      allContentNodes.forEach( cnode => {
        let opt = document.createElement('option');
        opt.value = cnode.dataFile; 
        opt.textContent = cnode.fullDisplay; // e.g. "CNS - Anatomy"
        sel.appendChild(opt);
      });
    }
    function getAllContentNodes(nodes, path){
      let result = [];
      nodes.forEach((n, i) => {
        let currentPath = [...path, i];
        if(n.dataFile){
          // build display
          let fullTitles = getNodePathTitles(expTopics.topics, buildPathForGetNode(path, i));
          let displayText = joinForDisplay(fullTitles);
          result.push({ dataFile: n.dataFile, fullDisplay: displayText });
        }
        if(n.subtopics && Array.isArray(n.subtopics)){
          result = result.concat(getAllContentNodes(n.subtopics, [...path, i, 'subtopics']));
        }
      });
      return result;
    }
    function buildPathForGetNode(par, idx){
      // par = array of indexes and 'subtopics' strings
      // we want to rebuild a path like ["topics", 0, "subtopics", 1 ... idx]
      let out = ["topics"];
      for(let x of par){
        if(x==='subtopics' || typeof x === 'number'){
          out.push(x);
        }
      }
      out.push(idx);
      return out;
    }

    /* ==================== Load content file (dataFile) ==================== */
    async function loadContentFile(){
      let sel = document.getElementById('contentNodesSelect');
      if(!sel.value){
        alert("Please select a content node");
        return;
      }
      currentContentFile = sel.value; // e.g. exp_data/CNS_Anatomy.json
      try {
        let r = await fetch('/api/get-content-file?filePath='+encodeURIComponent(currentContentFile));
        let j = await r.json();
        if(!j.success){
          document.getElementById('contentLoadMsg').innerHTML = `<div class="alert alert-danger">Failed to load: ${j.error||''}</div>`;
          return;
        }
        currentContentSha = j.sha;
        let contentObj = j.content;
        if(!contentObj.content) contentObj.content = "";
        originalContentHtml = contentObj.content;
        document.getElementById('contentEditor').innerHTML = contentObj.content;
        document.getElementById('contentLoadMsg').innerHTML = `<div class="alert alert-success">Content loaded successfully!</div>`;
      } catch(e){
        console.error(e);
        alert("Error loading content file");
      }
    }

    /* ==================== Save content file ==================== */
    async function saveContentChanges(){
      if(!currentContentFile){
        alert("No content file selected.");
        return;
      }
      let confirmSave = await confirm("Are you sure you want to save current content?");
      if(!confirmSave) return;
      let updatedHtml = document.getElementById('contentEditor').innerHTML;

      let payload = {
        filePath: currentContentFile,
        sha: currentContentSha,
        newContent: updatedHtml
      };
      try {
        let r = await fetch('/api/save-content-file', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        let j = await r.json();
        if(j.success){
          alert("Content saved!");
          originalContentHtml = updatedHtml;
          if(j.newSha) currentContentSha = j.newSha;
        } else {
          alert("Save failed: " + (j.error||''));
        }
      } catch(e){
        console.error(e);
        alert("Error saving content file");
      }
    }

    /* ==================== Preview content ==================== */
    function previewContent(){
      let html = document.getElementById('contentEditor').innerHTML;
      let previewArea = document.getElementById('previewArea');
      let previewContent = document.getElementById('previewContent');
      previewContent.innerHTML = html;
      previewArea.style.display = 'block';
    }
  </script>
</body>
</html>
